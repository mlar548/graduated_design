jQuery.jCookie = function (name, value, options) {
    if (typeof value != 'undefined') { // name and value given, set cookie
        options = options || {};
        if (value === null) {
            value = '';
            options.expires = -1;
        }
        var expires = '';
        if (options.expires
				&& (typeof options.expires == 'number' || options.expires.toUTCString)) {
            var date;
            if (typeof options.expires == 'number') {
                date = new Date();
                date.setTime(date.getTime()
						+ (options.expires * 24 * 60 * 60 * 1000));
            } else {
                date = options.expires;
            }
            expires = '; expires=' + date.toUTCString(); //FavoriteProduct use expires
            // attribute,
            // max-age is not
            // supported by IE
        }
        var path = options.path ? '; path=' + options.path : '';
        var domain = options.domain ? '; domain=' + options.domain : '';
        var secure = options.secure ? '; secure' : '';
        document.cookie = [name, '=', escape(value), expires, path, domain,
				secure].join('');
    } else { // only name given, get cookie
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = unescape(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
};

//显示二维码
function ShowQRCode() {
    var qrIconObj = $("#site-qrcode");
    $("#divQRCode").css({ left: (qrIconObj.offset().left - 26) + "px", top: (qrIconObj.offset().top - 152) + "px" }).show();
}
//隐藏二维码
function HideQRCode() {
    $("#divQRCode").hide();
}

window.Ecs = window.Ecs || {};
Ecs.ProductInfo = {
    Url: "/controls/productinfo.ashx",
    AddCartUrl: "/controls/CartOrderHandler.ashx",
    DefaultMethod: "POST",
    RollnextCount: 1,
    option: {
        SelectItem: null,
        //是否显示分享
        IsShowShareBtn: false,
        //分享按钮HTML
        ShareBtnHtml: '<span><a target="_blank" title="分享">分享到：</a></span><div><a href="javascript:void(0)" onclick="Ecs.Tool.ShareTo(\'tsina\')" id="site-sina" title="分享到新浪微博">sina</a> <a href="javascript:void(0)" onclick="Ecs.Tool.ShareTo(\'qqblog\')" id="site-qzone"title="分享到腾讯微博">腾讯QQ</a> <a href="javascript:void(0)" onclick="Ecs.Tool.ShareTo(\'renren\')"id="site-renren" title="分享到人人">renren</a> <a href="javascript:void(0)" onclick="Ecs.Tool.ShareTo(\'kaixin001\')"id="site-kaixing" title="分享到开心网">kaixing</a> <a href="javascript:void(0)" onclick="Ecs.Tool.ShareTo(\'douban\')"id="site-douban" title="分享到豆瓣">douban</a> <a href="javascript:void(0)" onclick="Ecs.Tool.ShareTo(\'msn\')"id="site-msn" title="分享到MSN">msn</a> <a onclick="Ecs.Tool.ShareTo(\'qq\')" href="javascript:void(0)"id="site-qq" title="QQ书签">qq</a></div>',
        //货号列表
        GoodJson: null,
        //最小价格为null或0时显示询价
        MinPrice: null,
        //显示库存 【0，不显示，1显示虚拟库存，2显示实际库存】
        IsShowInventory: 0,
        //是否开启仓库地区精确设置
        StorageOneSetting: false,
        //库存是否以数字显示
        IsShowInNumber: false,
        //是否站外商品
        IsOuterUrl: false,
        //是否开启零库存下单
        IsZeroStorePay: false,
        StorageDetailJson: null,
        AllStockamount: null,
        AllCount: null,
        //选中货号最大库存
        SelectGoodsMaxCount: 0,
        Unit: "",
        BitUnit: "",
        UnitRate: 0,
        XsAsk: false,
        XsComment: false,
        //促销框
        PromoTip: null,
        DisableGoods: "",
        ProductName: "",
        IsStoreProduct: 0,
        WholeSale: {
            IsWholeSaleProduct: 0,
            WholeProductName: ""
        }
    },
    //保存最后的组合结果信息
    SKUResult: {},
    SKUData: {},
    //获得对象的key
    getObjKeys: function (obj) {
        if (obj !== Object(obj)) throw new TypeError('Invalid object');
        var keys = [];
        for (var key in obj)
            if (Object.prototype.hasOwnProperty.call(obj, key))
                keys[keys.length] = key;
        return keys;
    },

    //显示按钮及库存
    ShowButton: function (item) {
        var ecs = this;
        $(".addshoppingcart input:not(.prodinfo-btn-noteused)").hide();
        if ($(".addshoppingcart input[class*=prodinfo-btn-noteused]").length > 0)
            $(".productnum").hide();
        ecs.ShowStockCount(item);
        ecs.ShowPrice(ecs, item);
        ecs.updateUnitPrice();
        var count = ecs.option.SelectGoodsMaxCount;
        if (item == null) {
            if (count > 0 || ecs.option.IsZeroStorePay) {
                $("#buy").show();
                $("#peatbuy").show();
                $("#collection").show();
                $("#quote").show();
            } else { ecs.ShowNoticeBtn(); }

        } else {

            //设置文本框输入数量限制
            ecs.SetCountLimit(ecs, item);
            ecs.option.SelectItem.Goods = item;
            if (item.vipprice > 0) {
                //站外链接
                if (ecs.option.IsOuterUrl) {
                    $("#outURL").show();
                }
                else if (count > 0 || ecs.option.IsZeroStorePay) {
                    $("#buy").show();
                    $("#peatbuy").show();
                    $("#collection").show();
                    $("#quote").show();
                } else {
                    Ecs.ProductInfo.ShowNoticeBtn();
                }
            } else {
                //是否是积分换购
                if (ecs.option.isRede) {
                    $("#buy").show();
                    $("#inquiry").hide();
                }
                else {
                    $("#buy").hide();
                    $("#inquiry").show();
                }
            }
            $("#huohao").html(item.productno);
            if (parseFloat(item.weight) > 0) {
                $(".productWeight").html(item.weight + (item.weightunit == "0" ? "克" : (item.weightunit == "1" ? "千克" : "吨")));
            }
            if (item.barcode != undefined && item.barcode.length > 0) {
                $("#barcode").parent().show();
                $("#barcode").html(item.barcode);
            }
            else {
                $("#barcode").parent().hide();
            }
            PreferentialSuit.render(item.PreferentialSuit, item.goodsid);
            RecommendedSuit.render(item.RecommendedSuit, item.goodsid);
            ecs.BindCombinationSalesEvent();
            ecs.GroupBuyInit();
        }
    },
    ResetImage: function (images) {
        var imageContainer = $(".jqzoom");
        var imageListContainer = $("#List1");
        var imageUrl = "";
        var compressImageUrl = "";
        var imageListHtml = "";
        if (images.length > 0) {
            imageUrl = images[0];
            compressImageUrl = images[0] + "_510x510.jpg";

            $.each(images, function (index) {
                imageListHtml += "<div class='pic" + (index == 0 ? " clickboder" : "") + "'>";
                imageListHtml += "  <table cellpadding='0' cellspacing='0'>";
                imageListHtml += "      <tbody>";
                imageListHtml += "          <tr>";
                imageListHtml += "              <td><img src='" + this + "_80x80.jpg'></td>";
                imageListHtml += "          </tr>";
                imageListHtml += "      </tbody>";
                imageListHtml += "  </table>";
                imageListHtml += "  <s></s>";
                imageListHtml += "</div>";
            });
        } else {
            imageListHtml += "<div class='pic clickboder'>";
            imageListHtml += "  <table cellpadding='0' cellspacing='0'>";
            imageListHtml += "      <tbody>";
            imageListHtml += "          <tr>";
            imageListHtml += "              <td><img src='/images/_07.png'></td>";
            imageListHtml += "          </tr>";
            imageListHtml += "      </tbody>";
            imageListHtml += "  </table>";
            imageListHtml += "  <s></s>";
            imageListHtml += "</div>";

            imageUrl = "/images/_07.png";
            compressImageUrl = "/images/_07.png";
        }

        imageContainer.attr("href", imageUrl);
        imageContainer.find("img").attr("src", compressImageUrl).attr("jqimg", imageUrl);
        imageListContainer.html(imageListHtml);

        //图片列表滚动处理
        if ($(".rollBox").length > 0) {
            Ecs.ProductInfo.RollnextCount = 1;
            Ecs.ProductInfo.SmallProductPicScroll(".rollBox");
        }

        this.JqueryZoom();
    },

    /*数量限制*/
    SetCountLimit: function (ecs, item) {
        var count = ecs.option.SelectGoodsMaxCount;
        var stockinfo = item.StockInfo[0];
        var mincount = parseFloat(stockinfo.minqty) > 1 ? parseFloat(stockinfo.minqty) : 0;
        var maxcount = parseFloat(stockinfo.maxqty);
        maxcount = isNaN(maxcount) || maxcount == 0 ? parseFloat(stockinfo.maxstock) : maxcount;
        if (!ecs.option.IsZeroStorePay) {
            maxcount = (isNaN(maxcount) || maxcount == 0 || maxcount > count) ? count : maxcount;
        }
        //设置最小/最大购买数量
        $(".productchoose .buynuminput").attr("mincount", mincount).val(mincount == 0 ? 1 : mincount);
        $(".productchoose .buynuminput").attr("maxcount", maxcount);
    },


    /*价格显示*/
    ShowPrice: function (ecs, item) {
        if (item == null || item == undefined) {
            $("#li_promo").hide();
            $("#tbuytitle").hide();
            ecs.ShowTieredPrice(ecs, ecs.option.TieredPrice, ecs.option.isopentieredprice);
            return;
        }

        //市场价
        var mktprice = parseFloat(item.mktprice);
        var vipprice = parseFloat(item.vipprice);
        if (mktprice > 0){
            $(".product_attr .oldprice").html("&yen;" + mktprice.toFixed(2)).show();
            $(".product_attr .cankaojia").show();
        } else {
            $(".product_attr .oldprice").html("").hide();
            $(".product_attr .cankaojia").hide();
        }
        ecs.option.SelectItem.wholesaletype = -1;
        if (!ecs.option.isRede) {
            $("#productinfo_priceshow .currentprice").html(vipprice.toFixed(2));
            ecs.ShowPromoteInfo(item, ecs);
        }
        ecs.ShowTieredPrice(ecs, item.TieredPrice, item.isopentieredprice);
        $("#productinfo_priceshow .currentprice").attr("price", $("#productinfo_priceshow .currentprice").html());
    },

    /*显示阶梯价格*/
    ShowTieredPrice: function (ecs, item, isOpenTieredPrice) {
        if ($(".login-showprice-wrap").length > 0) {
            return;
        }
        var isTraceOrPromote = isOpenTieredPrice == "False" ? false : (item != undefined && item.length > 0 ? item[0].IsTraceOrPromote : false);
        if (isOpenTieredPrice == "False" || isTraceOrPromote) {
            $("#productinfo_priceshow").show();
            $(".ladder-price").hide();
            return;
        }
        var title = "";
        var content = "";
        $.each(item, function (i, tieredPrice) {
            title += " <td class='ladder-" + item.length + "-" + (i + 1) + "'>￥<span>" + tieredPrice.Price + "</span></td>";
            if (tieredPrice.QuantityTo == 2147483647) {
                content += "<td class='ladder-" + item.length + "-" + (i + 1) + "'>≥" + tieredPrice.QuantityFrom + ecs.option.Unit + "</td>";
            }
            else { content += " <td class='ladder-" + item.length + "-" + (i + 1) + "'>" + tieredPrice.QuantityFrom + "~" + tieredPrice.QuantityTo + ecs.option.Unit + "</td>"; }
        });
        title = "<tr class='price'><td class='price-title ladder-1'>起批价</td>" + title + "</tr>";
        content = "<tr class='amount'><td class='amount-title ladder-1'>起订量</td>" + content + "</tr>";
        $("#productinfo_priceshow").hide();
        $(".ladder-price").html("<table>" + title + content + "</table>").show();
    },

    /*当没有选中的货品时，显示的价格范围*/
    ShowPriceRange: function () {
        var ecs = this;
        var prices = [];
        $.each(ecs.SKUResult, function (i, pitem) {
            if (pitem.item.price == undefined)
                prices[prices.length] = pitem.item[0][0].vipprice == undefined || pitem.item[0][0].vipprice == "" ? pitem.item[0][0].price : pitem.item[0][0].vipprice;
            else
                prices[prices.length] = pitem.item[0].vipprice == undefined || pitem.item[0].vipprice == "" ? pitem.item[0].price : pitem.item[0].vipprice;
        });

        var maxPrice = Math.max.apply(Math, prices);
        var minPrice = Math.min.apply(Math, prices);
        minPrice = Number(minPrice);
        maxPrice = Number(maxPrice);
        $(".product_body_right .product_attr .currentprice").html(maxPrice > minPrice ? minPrice.toFixed(2) + "-" + maxPrice.toFixed(2) : maxPrice.toFixed(2));
        $(".product_body_right .product_attr .currentprice").attr("price", $(".product_body_right .product_attr .currentprice").html());
        var $currprice = $('[data-price="curr"]');
        if ($currprice.length) {
            $currprice
            .html(maxPrice > minPrice ? minPrice.toFixed(2) + "-" + maxPrice.toFixed(2) : maxPrice.toFixed(2))
            .attr("price", $currprice.html());
        }
    },


    /*促销信息显示*/
    ShowPromoteInfo: function (item, ecs) {
        //console.log(item);
        if (item == null || item == undefined) {
            $("li[state=showShowActivity]", $("#li_promo").parent()).show();
            return;
        }
        $("li[state=showShowActivity]", $("#li_promo").parent()).hide();
        $("#li_promo").hide();
        $("#tbuytitle").hide();
        $("#tuanortimetitle").remove();
        //促销信息
        if (item.ActivityInfo != undefined && item.ActivityInfo != null) {
            //PC端不显示 分享活动
            if (item.ActivityInfo.mintype == "20" || item.ActivityInfo.mintype == 20)
                return;

            var promotitle = item.ActivityInfo.wholename;
            if (item.ActivityInfo.wholesaletype == WholesaleType.GroupBuy || item.ActivityInfo.wholesaletype == WholesaleType.ScareBuy) { //团抢购商品
                ecs.option.SelectItem.wholesaletype = item.ActivityInfo.wholesaletype;
                if ($("#tbuytitle").length > 0) {
                    if ($(".product_price_inner .left").css("float") == "left") {
                        $(".payway").before("<div id='tuanortimetitle'></div>");
                    } else {
                        $("#tbuytitle").append("<div id='tuanortimetitle'></div>");
                    }
                }
                //$("#tuanortimetitle").html("<span style='display: inline' datetime='" + item.ActivityInfo.enddate + "' class='time' begindatetime='" + item.ActivityInfo.startdate + "' isrun='0'></span>").show();
                var pdinfoWscdPartHtml = '<div class="pdinfo-wscd-part" id="pdinfo-wscd-part" data-sdate="' + item.ActivityInfo.startdate + '" data-edate="' + item.ActivityInfo.enddate + '"><img src="/template/images/Public/wholesales/zhong.png"/><span class="wscd-titleshow"></span><span class="wscd-dayshow"><i>0</i><em>天</em></span><span class="wscd-hourshow"><i>00</i><em>小时</em></span><span class="wscd-minshow"><i>00</i><em>分</em></span><span class="wscd-secshow"><i>00</i><em>秒</em></span></div>';
                $("#tuanortimetitle").empty().append(pdinfoWscdPartHtml).show();
                $("#tbuytitle").show();

                promotitle = "此商品正在进行" + (item.ActivityInfo.wholesaletype == WholesaleType.GroupBuy ? "团" : "抢") + "购活动，数量有限，赶紧下手哦！";
                $("#productName").html(item.ActivityInfo.wholename.length > 0 ? item.ActivityInfo.wholename : ecs.option.productname);
                //window.clearTimeout(Ecshop.HotTemBuy.SetTimeoutObj);
                //Ecshop.HotTemBuy.RunSetDateTime('#tuanortimetitle', 'time');
                var $pdinfoWscdObj = $('#pdinfo-wscd-part')
                setTimeout(function () {
                    $pdinfoWscdObj.length && wholeSaleCountDown('#pdinfo-wscd-part', {
                        afterOver: function () {
                            document.location.reload(true);
                            return false;
                        }
                    });
                }, 0);
                $("#i_promoinfo").hide();
                $("#quote").hide();
            } else {
                if (item.ActivityInfo.wholesaletype == WholesaleType.ZengPin) {
                    promotitle += "<span style='color:black'>(送完为止)</span>";
                }
                //普通促销
                var promoinfos = Ecs.Tool.HTMLDeCode(Ecs.Tool.HTMLDeCode(item.ActivityInfo.promoinfo)).split("####");
                var promoinfohtml = "";
                $.each(promoinfos, function (i, item) {
                    if ($.trim(item).length > 0) {
                        var values = item.split(',');
                        var html = "";
                        $.each(values, function (j, _html) {
                            if (j != 0 && _html.length > 0) {
                                html += (html.length == 0 ? "" : "<br/>") + _html;
                            }
                        });
                        promoinfohtml += "<tr><td class='tdleft' style='padding:3px'>" + values[0] + "</td><td class='tdright' style='padding:3px'>" + html + "</td></tr>";

                    }
                });
                ecs.option.PromoTip.data("tooltip").updateContent("<div class='wholesalelr' style='padding:10px'><table cellpadding='0' cellspacing='0' border='0'><tbody id='promoinfo'>" + promoinfohtml + "</tbody></table></div>");
                $("#i_promoinfo").show();
            }

            $("#promotitle").css("color", "red").html(promotitle);
            $("#saletypeico").attr("class", "wholesale" + item.ActivityInfo.wholesaletype);
            $("#li_promo").show();
        }
    },

    /*商品所有库存显示方式*/
    ShowStockCount: function (goodsInfo) {
        var ecs = this;
        var stockJson = null;
        ecs.option.AllStockamount = 0;
        ecs.option.AllCount = 0;
        if (goodsInfo == null) {
            stockJson = ecs.option.GoodJson;
        } else {
            stockJson = goodsInfo.StockInfo;
        }

        $.each(stockJson, function (i, item) {
            ecs.option.AllStockamount += Number(item.virtualstockamount);
            ecs.option.AllCount += Number(item.realstockamount);
        });
        ecs.option.SelectGoodsMaxCount = ecs.option.IsShowInventory != 2 ? ecs.option.AllStockamount : ecs.option.AllCount;
        if (ecs.option.IsShowInventory != 0) {
            var counttext = "";
            if (!ecs.option.IsShowInNumber) {
                
                if (ecs.option.SelectGoodsMaxCount > 0) {
                    counttext = "有货";
                } else if (ecs.option.IsZeroStorePay) {
                    if (goodsInfo != null && goodsInfo.ActivityInfo != null && (goodsInfo.ActivityInfo.wholesaletype == WholesaleType.ScareBuy || goodsInfo.ActivityInfo.wholesaletype == WholesaleType.GroupBuy)) {
                        counttext = "无货";
                    }
                    else
                        counttext = "有货";
                }
                else
                    counttext = "有货";
            } else {
                counttext = "库存:" + ecs.option.SelectGoodsMaxCount;
            }

            $(".product_body_right .product_attr span.kcu").html(counttext);
        } else {
            $(".product_body_right .product_attr span.kcu").hide();
        }
    },


    //对店铺、与平台库存为0的显示方式
    ShowNoticeBtn: function () {
        var noticebtn = $("#notice");
        noticebtn.show();
        //if (Ecs.ProductInfo.option.IsStoreProduct != 0) {
        //    noticebtn.val("暂无库存").unbind().removeClass("prodinfo-btn-styleone").addClass("prodinfo-btn-stylethree");
        //}
    },

    GetKeyLength: function (aryKey, aryIds) {
        var result = 0;
        for (var key in aryKey) {
            for (var id in aryIds) {
                if (aryKey[key] == aryIds[id])
                    result = result + 1;
            }
        }
        return result;
    },

    /*根据组合规格，查询对应的货品*/
    GetSkusItem: function (selectids) {
        var ecs = this;
        var result = null;
        for (key in ecs.SKUResult) {
            var newkey = key + ";";
            var isfalse = false;
            var length = ecs.GetKeyLength(newkey.split(";"), selectids);
            isfalse = (newkey.split(";").length - 1) == length && length == selectids.length;
            if (isfalse) {
                result = ecs.SKUResult[key].item;
                break;
            }
        }
        return result;
    },


    /*选择规格*/
    SelectSpec: function (e) {
        var ecs = this;
        if (e.attr("class") != undefined && e.attr("class").indexOf("disable") >= 0)
            return;
        e.toggleClass('select').siblings().removeClass('select');
        var parent = e.parent();
        var pid = parent.attr("gvid");
        var selectLength = $(".select_colorszie ul li span[class='select']").length;

        var prop = pid + ":" + e.attr("vid");
        if (selectLength > 0) {
            $(".select_colorszie ul li span[class='select']").each(function () {
                if ($(this).attr("vid") != e.attr("vid"))
                    prop += prop.length == 0 ? $(this).parent().attr("gvid") + ":" + $(this).attr("vid") : ";" + $(this).parent().attr("gvid") + ":" + $(this).attr("vid");
            });
        }

        //设置规格显示状态
        ecs.SetSpecState(e);

        var props = prop.split(";");
        if ($(".select_colorszie ul li span[class='sptitle']").length == $(".select_colorszie ul li span[class='select']").length) {

            var selectData = new Array();
            $.each(ecs.option.GoodJson, function (i, item) {
                var isExtend = true;
                for (var j = 0; j < props.length; j++) {
                    if (item.pdtdesc.indexOf(props[j]) >= 0)
                        isExtend = !isExtend ? false : true;
                    else
                        isExtend = false;
                }
                if (isExtend)
                    selectData.push(item);
            });
            ecs.option.SelectItem = selectData[0];
            ecs.AsynLoadGoodsInfo();
        }

        else {
            ecs.option.SelectItem = null;
            ecs.ShowPriceRange();
            ecs.ShowPromoteInfo(null);
            ecs.ShowButton(null);
        }
    },

    /*设置规格显示状态*/
    SetSpecState: function (e) {
        var ecs = this;
        var selectedObjs = $(".select_colorszie ul li span[class='select']");
        if (selectedObjs.length) {
            //获得选中的规格
            var selectedIds = [];
            selectedObjs.each(function () {
                selectedIds.push($(this).attr('vid'));
            });
            selectedIds.sort(function (value1, value2) {
                return parseInt(value1) - parseInt(value2);
            });
            var len = selectedIds.length;

            ////用已选中的节点验证待测试节点 underTestObjs
            $(".select_colorszie ul li span[class!='sptitle']").not(selectedObjs).not(e).each(function () {
                var siblingsSelectedObj = $(this).siblings('.select');
                var testAttrIds = []; //从选中节点中去掉选中的兄弟节点
                if (siblingsSelectedObj.length) {
                    var siblingsSelectedObjId = siblingsSelectedObj.attr('vid');
                    for (var i = 0; i < len; i++) {
                        (selectedIds[i] != siblingsSelectedObjId) && testAttrIds.push(selectedIds[i]);
                    }
                } else {
                    testAttrIds = selectedIds.concat();
                }
                testAttrIds = testAttrIds.concat($(this).attr('vid'));
                testAttrIds.sort(function (value1, value2) {
                    return parseInt(value1) - parseInt(value2);
                });
                var skusitem = ecs.GetSkusItem(testAttrIds);
                if (!skusitem) {
                    $(this).addClass("disable").removeClass('select');
                } else {
                    $(this).removeClass("disable");
                }
            });
        } else {
            //设置属性状态
            $(".select_colorszie ul li span[class!='sptitle']").each(function () {
                ecs.GetSkusItem($(this).attr('vid').split(";")) ? $(this).removeClass("disable") : $(this).addClass("disable").removeClass('select');
            });
        }
    },

    /*加载货品信息*/
    AsynLoadGoodsInfo: function (callback) {
        var ecs = this;
        var areaId = $("#djdAreaOpt").val();
        if (ecs.option.SelectItem == undefined) return;
        var unit = ecs.option.selectUnit ? ecs.option.selectUnit : 0;
        $.ajax({
            url: '/controls/proudct.ashx',
            type: 'POST',
            data: { type: "getgoods", goodsId: ecs.option.SelectItem.goodsid, areaId: areaId, unit: unit },
            dataType: 'json',
            async: false,
            success: function (data) {
                ecs.ShowButton(data);
                ecs.ResetImage(data.Images);
                /*有回调函数*/
                if (typeof( callback)=="function"){
                    callback();
                }
            }
        });
    },
    /*加载服务商信息*/
    AsynLoadServerProvider: function () {
        var areaId = $("#djdAreaOpt").val();
        if (Ecs.ProductInfo.option.GoodJson[0] == undefined) return;
        $.ajax({
            url: '/controls/proudct.ashx',
            type: 'POST',
            data: { type: "serverprovider", productId: Ecs.ProductInfo.option.GoodJson[0].productid, areaId: areaId },
            dataType: 'json',
            async: false,
            success: function (json) {
                if (json == null || json == undefined || json.length == 0) {
                    $("#ServerProviderHtml").html("");
                    return;
                }
                var str = "<div class='provider-list clearfix'><span class='provider-list-t'>服务商：</span><div class='provider-list-content' id='provider-list-content'><ul>";
                $.each(json, function (i, item) {
                    str += "<li class='clearfix'><span class='company-name'>" + item.companyname + "</span><a class='view-map' href='javascript:;' onclick=\"loadServerProviderMap('" + item.defaultaddress + item.address + "','" + item.locationpoint + "','" + item.mobile + "','" + item.companyname + "')\">查看地图</a></li>";
                });
                str += "</ul><div class='map-content' id='map-content'><div id='allmap' class='allmap'></div><i class='close-map' onclick='$(\"#map-content\").hide()'></i></div></div></div>";
                $("#ServerProviderHtml").html(str);
                $("#map-content").css({ "left": $("#provider-list-content").width() + 10 + "px" });
            }
        });

    },
    //显示或隐藏定购
    IsShowInfobuyList: function (e) {
        $(".addshoppingcart input").hide();
        $("#buy").show();
        $("#peatbuy").show();
        $("#collection").show();
        $("#quote").show();
        if ($("#goods_products_list_buy").css("display") == "none") {
            $(".productchoose .addshoppingcart").addClass("add_cart").appendTo($("#goods_products_list_buy"));
            //            $("#showwholesale").css("display", "none");
            $(".productchoose").css("display", "none");
            //            $(".addshoppingcart").css("display", "none");
            //            $(".productnum").css("display", "none");
            $("#goods_products_list_buy").css("display", "");
            $("#buy").hide();
            $("#peatbuy").hide();
        } else {
            $(".select_colorszie ul li span[class='select']").removeClass("select");
            $(".select_colorszie ul li span[class='disable']").removeClass("disable");
            Ecs.ProductInfo.option.SelectItem = "";
            $("#goods_products_list_buy").find(".addshoppingcart").removeClass("add_cart").appendTo($(".productchoose"));
            $(".productchoose").css("display", "");
            $("#goods_products_list_buy").css("display", "none");
            $("#buy").show();
            $("#peatbuy").show();
        }
    },
    //批发规则
    IsShowWholesale: function (e, event) {
        var ecs = this;
        $("#showwholesale").css({
            top: function () {
                if ("goods_products_list_buy_title" == $(e).parent().attr("class"))
                    return $(e).offset().top + 30 + "px";
                else
                    return $(e).offset().top + 20 + "px";
            },
            left: function () {
                if ("goods_products_list_buy_title" == $(e).parent().attr("class"))
                    return $(e).offset().left - $(this).width() / 2 + "px";// - ($(this).width() - $(e).parent().width())
                else
                    return $(e).offset().left - $(this).width() / 2 + "px";// - ($(this).width() - $(e).parent().width())
            },
            zIndex: function () {
                return "9990";
            }
        });
        $("#showwholesale").slideToggle();
        ecs.StopEvent(event);

    },
    //图片列表滚动
    SmallProductPicScroll: function (obj) {
        var obj = $(obj);
        var pic = obj.find(".pic");
        var obj_length = pic.size();
        var obj_item_width = pic.outerWidth(true);
        var obj_scroll = obj.find(".ScrCont");
        obj_scroll.css("left", "0px");
        var _scrollcount = 0;
        var _visvabilecount = 4;
        var scroll = {
            init: function () {
                if (obj_length > 4) {
                    scroll.next();
                    scroll.prve();
                    //console.log("run function!");
                }
                scroll.hover();
            },
            next: function () {
                obj.find(".rollnext").bind("click", function () {
                    //                    console.log(window.parseInt(obj_scroll.css("left")));
                    if (_scrollcount >= obj_length - _visvabilecount) {
                        _scrollcount = 0;
                    }
                    else {
                        _scrollcount++;
                    }
                    obj_scroll.animate({
                        left: -1 * _scrollcount * obj_item_width + "px"
                    }, "fast");
                });
            },
            prve: function () {
                obj.find(".rollprv").bind("click", function () {
                    if (_scrollcount == 0) {
                        _scrollcount = obj_length - _visvabilecount;
                    }
                    else {
                        _scrollcount--;
                    }
                    obj_scroll.animate({
                        left: -1 * _scrollcount * obj_item_width + "px"
                    }, "fast");
                });
            },
            getnext: function () {
                obj.find(".rollnext").bind("click", function () {
                    if (Ecs.ProductInfo.RollnextCount >= obj_length) {
                        Ecs.ProductInfo.RollnextCount = 1;
                    } else {
                        Ecs.ProductInfo.RollnextCount++;
                    }
                    scroll.changezoomimg();
                });
            },
            getprv: function () {
                obj.find(".rollprv").bind("click", function () {
                    if (Ecs.ProductInfo.RollnextCount <= 1) {
                        Ecs.ProductInfo.RollnextCount = obj_length;
                    } else {
                        Ecs.ProductInfo.RollnextCount--;
                    }
                    scroll.changezoomimg();
                });
            },
            changezoomimg: function () {
                pic.removeClass("clickboder");
                pic.eq(Ecs.ProductInfo.RollnextCount - 1).addClass("clickboder");
                pic.find("s").hide();
                pic.eq(Ecs.ProductInfo.RollnextCount - 1).find("s").show();
                t_picimg = pic.eq(Ecs.ProductInfo.RollnextCount - 1).find("img");
                if (t_picimg.attr("src").indexOf("taobao") > -1) {
                    $(".zoomimg").attr("src", t_picimg.attr("src").replace("80x80.jpg", "310x310.jpg"));
                } else {
                    $(".zoomimg").attr("src", t_picimg.attr("src").replace("80x80.jpg", "510x510.jpg"));
                }
                $(".jqzoom").attr("href", t_picimg.attr("src").replace("_80x80.jpg", ""));
                $(".zoomimg").attr("jqimg", t_picimg.attr("src").replace("_80x80.jpg", ""));
            },
            hover: function () {
                pic.bind("mouseover", function () {
                    $(this).animate({ opacity: 0.7 }, 1);
                });
                pic.bind("mouseout", function () {
                    $(this).animate({ opacity: 1 }, 1);
                });
            }
        }
        scroll.init();
    },
    //设置B2C货号列表显示隐藏
    SetSelectColorszie: function () {
        $("#select_colorszie_child table tr:first").find("th").css({
            background: function () {
                return "#DEE4E8";
            },
            fontWeight: function () {
                return "bold";
            }
        });
        $("#select_colorszie").hover(function () {
            $("#select_colorszie_child").show();
            $("#select_colorszie_child").css("left", "0");
            if ($("#select_colorszie_child").css("left") == "0px") {
                var width = 465;
                width = $("#select_colorszie_child").outerWidth();
                var left = $("#select_colorszie").offset().left - width + 20;
                $("#select_colorszie_child").css({ left: left + "px", zIndex: "9999" });
            }

        });
    },

    //增加减少购买数量(商品详情页）
    UpdateBuyCount: function (number, e, isinput) {
        var flag = true;
        var ecs = this;
        var item = ecs.option.SelectItem;
        var input = isinput ? $(e) : $(e).parent().find("input");


        /*检查是否允许录入小数 alan 2016.09.23*/
        if (typeof (__global_Order_Goods_Qty_Must_Int) != 'undefined') {
            if (__global_Order_Goods_Qty_Must_Int == 1) {
                var pice = input.val().replace(/^([0-9]{0,5})$/, '');
                if (pice.length > 0) {
                    Ecs.Tool.addLayerWoring(input, "不允许录入小数");
                    input.val(0);
                    return false;
                }
            }
        }
        /*检查是否允许录入小数 alan 2016.09.23*/

        var unitConfig = ecs.GetUnitCovertConfig();
        var selectrate = unitConfig.selectrate;
        var productNum = parseFloat(number);
        var baseunit = unitConfig.baseunit;
        ecs.currentUnitRate = parseFloat(selectrate);
        ecs.updateUnitPrice();
        if ((item == undefined || item == null) && document.location.href.toLowerCase().indexOf("productinfo") >= 0) {
            Ecs.Tool.addLayerWoring(input, "请先选择货品");
            input.val("1");
            return false;
        }

        if (isinput)
            number = productNum * selectrate;
        else {
            productNum = parseFloat(input.val()) + productNum;
            number = productNum * selectrate;
        }
        number = number.ToFormatDecimalMaxTwoPlace();
        var maxbuy = parseFloat(input.attr("maxcount"));

        var minbuy = parseFloat(input.attr("mincount"));
        //转换后的数量
        var egoodsisopentieredprice = ecs.option.SelectItem.Goods == undefined || ecs.option.SelectItem.Goods.isopentieredprice == undefined ? "False" : ecs.option.SelectItem.Goods.isopentieredprice;
        if (egoodsisopentieredprice == "True") {
            minbuy = ecs.option.SelectItem.Goods.TieredPrice[0].QuantityFrom;
        }
        var inputmaxbuy = parseFloat(maxbuy / selectrate);
        //inputmaxbuy = maxbuy % selectrate > 0 ? inputmaxbuy + 1 : inputmaxbuy;

        var inputminbuy = parseFloat(minbuy / selectrate);
        //inputminbuy = minbuy % selectrate > 0 ? inputminbuy + 1 : inputminbuy;
        if (unitConfig.selectValue == "0") {
            inputmaxbuy = maxbuy;
            inputminbuy = minbuy;
        }

        inputmaxbuy = inputmaxbuy.ToFormatDecimalMaxTwoPlace();
        inputminbuy = inputminbuy.ToFormatDecimalMaxTwoPlace();
        if (number > 0) {
            if (ecs.option.IsZeroStorePay) {
                if ((item.wholesaletype == WholesaleType.GroupBuy || item.wholesaletype == WholesaleType.ScareBuy) && number > ecs.option.SelectGoodsMaxCount) {
                    Ecs.Tool.addLayerWoring(input, "超过商品的库存数量");
                    input.val(ecs.option.SelectGoodsMaxCount);
                    flag = false;
                }
            } else if (number > ecs.option.SelectGoodsMaxCount) {
                Ecs.Tool.addLayerWoring(input, "超过商品的库存数量");
                input.val(inputmaxbuy);
                flag = false;
            }
            if (flag) {
                var isIntegralBuy = $("#chkpoints").prop("checked");
                if (!isIntegralBuy && number > maxbuy && maxbuy > 0) {
                    Ecs.Tool.addLayerWoring(input, "该商品最多允许购买" + inputmaxbuy + baseunit);
                    input.val(inputmaxbuy);
                    flag = false;
                } else if (!isIntegralBuy && number < minbuy && (minbuy - number) > 0.011) {
                    Ecs.Tool.addLayerWoring(input, "该商品最少购买" + inputminbuy + baseunit);
                    input.val(inputminbuy);
                    flag = false;
                } else {
                    input.val(productNum);
                }
            }
        } else {
            input.val(1);
        }
        ecs.SetUnit(input);
        return flag;
    },
    currentUnitRate: 1,
    updateUnitPrice: function () {
        var ecs = this;
        var priceObj = $("#productinfo_priceshow .currentprice");
        var _currentprice = 0;
        if (priceObj.attr("price") == undefined) {
            _currentprice = priceObj.html();
            priceObj.attr("price", priceObj.html());

        }
        else {
            _currentprice = priceObj.attr("price");
        }
        _currentprice = typeof (_currentprice) == "undefined" ? 0 : _currentprice;
        if (_currentprice && _currentprice.indexOf("-") > 0) {
            var arr = _currentprice.split("-");
            var minPrice = parseFloat(arr[0]) * ecs.currentUnitRate;
            var maxPrice = parseFloat(arr[1]) * ecs.currentUnitRate;
            _currentprice = minPrice.toFixed(2) + "-" + maxPrice.toFixed(2);
        } else {
            
            _currentprice = _currentprice.toString().replace("¥", "");
            _currentprice = _currentprice.toString().replace("￥", "");
            _currentprice = (parseFloat(_currentprice) * ecs.currentUnitRate).toFixed(2);
            _currentprice = "¥" + _currentprice;
        }
        priceObj.html(_currentprice);
         
    },
    //获得单位转换的配置
    GetUnitCovertConfig: function () {
        var ecs = this;
        var $this = $('input[name="productSelectUnit"]:checked');
        var config = {
            baseunit: "件",
            selectrate: 1,
            selectValue: "0",
            currentObj: null
        }
        if ($this.length > 0) {
            config.currentObj = $this;
            config.selectValue = $this.val();
            var selectValue = $this.val() == "0" || $this.val() == "1" ? "" : $this.val();
            if (config.selectValue == "0") {
                config.baseunit = ecs.option.Unit;
            } else {
                config.baseunit = ecs.option["BitUnit" + selectValue];
                config.selectrate = parseFloat(config.selectValue == "1" ? ecs.option["UnitRate"] : ecs.option["UnitRate" + selectValue]);
            }
        }

        return config;
    },

    SetUnit: function (input) {
        var unitConfig = Ecs.ProductInfo.GetUnitCovertConfig();
        var $this = unitConfig.currentObj;

        if ($(".productchoose").css("display") != "none" && $('input[name="productSelectUnit"]').length > 0) {
            var strUnit = "";
            var strBigUnit = "";
            if ($this != null && unitConfig.selectValue != "0") {
                strUnit = "&nbsp;&nbsp;<font style='font-size:14px;'>(" + input.val() + unitConfig.baseunit + ")</font>";
                var $thisparent = $this.parent();
                strBigUnit = "&nbsp;&nbsp;" + $thisparent.attr("title");
            }
            $(".productchoose .kucun").html(strUnit + strBigUnit);

        }
    },

    SelectUnit: function (e) {
        var input = $(".productchoose .buynuminput");
        Ecs.ProductInfo.option.selectUnit =$(e).find("input[type='radio']").val();
        var _this = this;
        _this.AsynLoadGoodsInfo(function () {
            _this.SetUnit(input);
            _this.UpdateBuyCount(input.val(), input, true);
        });
        _this.StopEvent(e);
    },
    //显示区域选择
    ShowSelectArea: function () {
        $(".product_attr .selectArea").toggle();
    },
    //选择地区[暂不删除，模版中使用了】
    SelectArea: function (e) {
        return;
    },

    //添加到购物车
    AddProductCart: function (e) {
        //alert("添加到购物车");
        if ($(e).attr("id") == "peatbuy")
            return false;
        var ecs = this;
        var gp = ecs.CheckProductType();
        var isAdd = true;
        if ($(e).attr("vid") == "1") {
            Ecs.Tool.addLayerWoring(e, "您没有该商品的代理权限,请联系客服。");
            return false;
        }
        gp = gp == null || gp == undefined ? "" : gp;
        var msg = "你没有选择";
        if ($(".productchoose").css("display") != "none") {
            if (ecs.option.SelectItem == null) {
                $(".select_colorszie ul li").each(function () {
                    if ($(this).children(".select").length == 0) {
                        if (msg == "你没有选择")
                            msg += "'" + $(this).children(".sptitle").text().replace("：", "") + "'";
                        else
                            msg += ",'" + $(this).children("span[class='sptitle']").text().replace("：", "") + "'";
                        isAdd = false;
                        return;
                    }
                });
            }
        }
        if (!isAdd) {
            Ecs.Tool.addLayerWoring(e, msg);
            return;
        }
        var productid = "";
        var goodsid = "";
        var count = "";
        var useUnit = "";
        if ($(".productchoose").css("display") == "none") {
            //批量订购
            $("#goods_products_list_buy .buynuminput").each(function () {
                var id = $(this).attr("id");
                if ($(this).val() != "0" && $(this).val() != "" && Math.floor($(this).val()) < Math.floor($(this).attr("maxcount"))) {
                    if (productid.length == 0) {
                        productid += id.split('-')[1];
                        goodsid += id.split('-')[0];
                        count += $(this).val();
                    } else {
                        productid += "," + id.split('-')[1];
                        goodsid += "," + id.split('-')[0];
                        count += "," + $(this).val();
                    }
                }
            });
        } else {
            var txtinput = $(".productchoose .buynuminput");
            var rdinput=$(".productchoose .unitselect input[type='radio']:checked");
            if (ecs.UpdateBuyCount(txtinput.val(), txtinput, true)) {
                var unitConfig = ecs.GetUnitCovertConfig();
                var selectrate = unitConfig.selectrate;
                var inputNum = Number($(".productchoose .buynuminput").val());
                productid = ecs.option.SelectItem.productid;
                goodsid = ecs.option.SelectItem.goodsid;
                count = parseFloat(inputNum) * selectrate;
                //当前选择的单位
                useUnit = $(rdinput).size() > 0 ? $(rdinput).val() : 0;
            } else {
                return false;
            }
        }
        if (!ecs.option.IsZeroStorePay) {
            if (productid.length == 0) {
                Ecs.Tool.addLayerWoring(e, "请输入购买数量。");
                return false;
            }
        }

        var provinceId = $("#djdStockOpt").val();
        var cityId = $("#djdCityOpt").val();
        var countyId = $("#djdAreaOpt").val();
        var locationId = provinceId + "-" + cityId + "-" + countyId;
        var province = "四川";
        var location = $("#selectAreachild").html();
        if (location != null && location != "") {
            province = location.substring(0, 2);;
            if (province == "黑龙" || province == "内蒙") {
                province = location.substring(0, 3);
            }
        }

        if (isAdd) {
            Ecs.ProductInfo.SetUserLastAreaid();
            if ($(e).attr("id") == "buy") {
                //alert("立即购买：" + count);
                var currentprice = $("span.currentprice").html().replace("&yen;", "");
                var totalprice = 0;
                if (currentprice != "")
                    totalprice = parseFloat(currentprice) * parseFloat(count);
                var sTop = $(window).scrollTop();
                var storeid = ecstempleStoreid;
                if (ecs.option.SelectItem.wholesaletype == WholesaleType.GroupBuy || ecs.option.SelectItem.wholesaletype == WholesaleType.ScareBuy) {
                    //团抢购商品立刻购买
                    if (ecs.option.SelectItem.wholesaletype == WholesaleType.GroupBuy)//团购
                        gp = "gp";
                    else if (ecs.option.SelectItem.wholesaletype == WholesaleType.ScareBuy)//团购
                        gp = "buy";
                    else
                        gp = "once";
                    var gt = (gp == "gp" ? 6 : (gp == "buy" ? 7 : 8));

                    var gdata = { type: 'oncetocartbuy', id: goodsid, ct: count, gt: gt, sid: storeid };
                    var gcart = Ecs.ProductInfo.crequest(gdata);
                    if (gcart != null) {
                        if (gcart.Status == 2 || gcart.Status == 0) {
                            if (gcart.Action == 9) {
                                $.dialog.open('/LoginDialog.aspx?btnid=buy&resulturi=' + encodeURI(document.location.href), { width: '400px', height: '540px', title: false, lock: true });
                            } else if (gcart.Action == 0 || gcart.Action == 5)
                                Ecs.Tool.addLayerWoring(e, Ecs.ProductInfo.cgetmessage(gcart.Code));
                            else Ecs.Tool.addLayerWoring(e, "发起立即购买失败，请稍后重试！");
                        }
                        if (gcart.Status == 1) {
                            window.location.href = "/cart/buy.aspx";

                        }
                    } else Ecs.Tool.addLayerWoring(e, "发送请求失败，请稍后重试！");
                }
                else {
                    //普通商品立刻购买
                    var isrede = Ecs.ProductInfo.CheckProductType() == 'rede';
                    var ispoint = ($("#chkpoints").length > 0 && $("#chkpoints").attr("checked"));
                    var rdata = { type: 'oncetocartbuy', id: goodsid, ct: count, gt: ispoint || isrede ? 9 : 5, sid: storeid };
                    var rcart = Ecs.ProductInfo.crequest(rdata);
                    if (rcart != null) {
                        if (rcart.Status == 2 || rcart.Status == 0) {
                            if (rcart.Action == 9) {
                                $.jCookie("productcount_" + productid, count, { path: "/" });
                                $.dialog.open('/LoginDialog.aspx?btnid=buy&resulturi=' + encodeURI("/productinfo/" + productid + "-" + goodsid + ($("#chkpoints").attr("checked") ? "-c" : "") + ".html"), {
                                    width: '400px', height: '540px', title: false, lock: true, fixed: true, init: function () {
                                        $(window).scrollTop(sTop);
                                    }
                                });
                            } else if (rcart.Action == 0 || rcart.Action == 5)
                                Ecs.Tool.addLayerWoring(e, Ecs.ProductInfo.cgetmessage(rcart.Code));
                            else Ecs.Tool.addLayerWoring(e, "发起立即购买失败，请稍后重试！");
                        }
                        if (rcart.Status == 1) {
                            $.jCookie("ipLoc-djd", locationId, { path: "/" });
                            $.jCookie("ipLocation", province, { path: "/" });
                            window.location.href = "/cart/buy.aspx";

                        }
                    } else Ecs.Tool.addLayerWoring(e, "发送请求失败，请稍后重试！");
                }
            }
            else {
                //alert("addcart");
                if (ecs.option.SelectItem.wholesaletype == WholesaleType.GroupBuy)//团购
                    gp = "gp";
                if (ecs.option.SelectItem.wholesaletype == WholesaleType.ScareBuy)//团购
                    gp = "buy";
                $.ajax({
                    type: Ecs.ProductInfo.DefaultMethod,
                    url: Ecs.ProductInfo.AddCartUrl,
                    data: "type=addcart&p=" + productid + "&g=" + goodsid +"&useUnit="+useUnit+ "&c=" + count + "&gp=" + gp + ($(e).attr("id") == "quote" ? "&u=1" : "&u=0"),
                    dataType: 'JSON',
                    success: function (data) {
                        if (data.iCookie == 1) {
                            if ($(e).attr("id") == "quote") {
                                window.location.href = "/cart/list.aspx?quote=quote";
                            } else {
                                $.jCookie("ipLoc-djd", locationId, { path: "/" });
                                $.jCookie("ipLocation", province, { path: "/" });
                                $("#shopping_numbermark,.shopping_numbermark").html(data.ct);
                                Ecs.Tool.addLayer(e, "加入购物车成功！");
                            }
                        } else {
                            Ecs.Tool.addLayerWoring(e, data.ct);
                        }
                    }
                });
            }
        }
    },
    curl: '/controls/CartOrderHandler.ashx',
    crequest: function (data) {
        var result = { Status: -1, Message: -1 };
        $.ajax({
            type: 'POST',
            dataType: "json",
            url: Ecs.ProductInfo.curl,
            data: data,
            async: false,
            error: function (request, textStatus, errorThrown) {
                result.Status = 2;
                result.Message = "数据请求异常，请刷新重试！";
            },
            success: function (json) {
                result = json;
            }
        });
        return result;
    },
    cgetmessage: function (code) {
        switch (code) {
            case "1091": return "商品数据异常!请重试";
            case "1092": return "未找到相应类型的商品!";
            case "1093": return "很抱歉，您不能购买自己的商品！";
            case "1094": return "立即购买失败，请刷新后重试";
            default:
                return "";
        }
    },    //优惠套餐
    AddCollocationPackage: function (e) {
        //alert("优惠套装");
        var storeid = ecstempleStoreid;
        var rel = $("#grouprod_mc_1 div.clearfix a.curr").attr("rel");
        var qty = $("input.combineqty").val();
        var arr = rel.split('_');
        if (arr.length != 2) {
            Ecs.Tool.addLayerWoring(e, "数据异常，请刷新页面重试！");
            return;
        }
        var gdata = { type: 'oncetocartbuy', id: arr[1], ct: qty, gt: 8, sid: storeid };
        var gcart = Ecs.ProductInfo.crequest(gdata);
        if (gcart != null) {
            if (gcart.Status == 2 || gcart.Status == 0) {
                if (gcart.Action == 9) {
                    $.dialog.open('/LoginDialog.aspx?btnid=btnCollocationPackage&resulturi=' + encodeURI(document.location.href), { width: '400px', height: '540px', title: false, lock: true });
                } else if (gcart.Action == 0 || gcart.Action == 5)
                    Ecs.Tool.addLayerWoring(e, Ecs.ProductInfo.cgetmessage(gcart.Code));
                else Ecs.Tool.addLayerWoring(e, "发起立即购买失败，请稍后重试！");
            }
            if (gcart.Status == 1) {
                window.location.href = "/cart/buy.aspx";

            }
        } else Ecs.Tool.addLayerWoring(e, "发送请求失败，请稍后重试！");
        //$.ajax({
        //    type: Ecs.ProductInfo.DefaultMethod,
        //    url: Ecs.ProductInfo.AddCartUrl,
        //    data: "type=collocationbuy&rel=" + rel + "&qty=" + qty,
        //    dataType: 'JSON',
        //    success: function (data) {
        //        if (data.iCookie == 0) {
        //            $.dialog.open('/LoginDialog.aspx?btnid=btnCollocationPackage&resulturi=' + encodeURI(document.location.href), { width: '400px', height: '540px', title: false, lock: true });
        //        } else if (data.iCookie == 200) {
        //            window.location.href = "/ordernew/cartbuy.aspx";
        //        }
        //    }
        //});
    },
    //优惠套餐加入购物车
    AddCollocationPackageToCartShop: function (e) {
        //alert("优惠套装");
        var rel = $("#grouprod_mc_1 div.clearfix a.curr").attr("rel");
        var qty = $("input.combineqty").val();
        $.ajax({
            type: Ecs.ProductInfo.DefaultMethod,
            url: Ecs.ProductInfo.AddCartUrl,
            data: "type=collocationbuytocartshop&rel=" + rel + "&qty=" + qty,
            dataType: 'JSON',
            success: function (data) {
                if (data.iCookie == 1) {
                    $("#shopping_numbermark,.shopping_numbermark").html(data.ct);
                    Ecs.Tool.addLayer(e, "加入购物车成功！");
                } else {
                    Ecs.Tool.addLayerWoring(e, "加入购物车失败！");
                }
            }
        });
    },
    //优惠搭配
    AddAccessory: function (e) {
        //alert("优惠搭配");
        var productid = "";
        var goodsid = "";
        var count = "";
        $("#grouprod_mc_2 ul.clearfix li").each(function () {
            var checkbox = $(this).find("input:checked");
            if (checkbox != null && checkbox.length > 0) {
                productid += $(checkbox).attr("pid") + ",";
                goodsid += $(checkbox).attr("gid") + ",";
                count += "1,";
            }
        });
        if (productid == "" || goodsid == "" || productid.length == 0 || goodsid.lenth == 0) {
            Ecs.Tool.addLayerWoring(e, "请选择搭配的商品！");
        } else {
            var h4 = $("#grouprod_mc_2 div.baseprod h4");
            var mpid = $(h4).attr("pid");
            var mgid = $(h4).attr("gid");
            productid += mpid;
            goodsid += mgid;
            count += "1";

            $.ajax({
                type: Ecs.ProductInfo.DefaultMethod,
                url: Ecs.ProductInfo.AddCartUrl,
                data: "type=addcart&p=" + productid + "&g=" + goodsid + "&c=" + count + "&gp=", //gp=accessory
                dataType: 'JSON',
                success: function (data) {
                    if (data.iCookie == 1) {
                        $("#shopping_numbermark,.shopping_numbermark").html(data.ct);
                        Ecs.Tool.addLayer(e, "加入购物车成功！");
                    } else {
                        Ecs.Tool.addLayerWoring(e, "加入购物车失败！");
                    }
                }
            });
        }
    },

    //判断是否为团/抢购商品
    CheckProductType: function () {
        var href = window.location.href;
        var redeck = ($("#chkpoints").attr("checked"));
        if (href.toLowerCase().indexOf("productinfo") >= 0)
            if (href.toLowerCase().substring(href.toLowerCase().indexOf("productinfo")).indexOf("-c") >= 0 && (redeck == "checked" || redeck == undefined))
                return "rede";
            else
                return "0";
        if (href.toLowerCase().indexOf("buyinginfo") >= 0)
            return "buy";
        if (href.toLowerCase().indexOf("teambuyinfo") >= 0)
            return "gp";
    },

    //计算优惠搭配价格
    CalculateAccessoryPrice: function (e) {
        var state = $(e).attr("checked");
        var tcount = $("#grouprod_mc_2 #tcount");
        var newtp = $("#grouprod_mc_2 #newtp");
        var oldtp = $("#grouprod_mc_2 #oldtp");

        var tcountVal = tcount.html();
        var newtpVal = newtp.html();
        var oldtpVal = oldtp.html();
        var xj = $(e).attr("xj");
        var yj = $(e).attr("yj");

        if (state == "checked" || state == true) {
            $(tcount).html(parseInt(tcountVal) + 1);
            newtp.html((parseFloat(newtpVal) + parseFloat(xj)).toFixed(2));
            oldtp.html((parseFloat(oldtpVal) + parseFloat(yj)).toFixed(2));
        } else {
            $(tcount).html(parseInt(tcountVal) - 1);
            newtp.html((parseFloat(newtpVal) - parseFloat(xj)).toFixed(2));
            oldtp.html((parseFloat(oldtpVal) - parseFloat(yj)).toFixed(2));
        }
    },
    /*设置上次购买的地区*/
    SetUserLastAreaid: function () {
        if ($.trim($("#djdAreaOpt").val()).length != 0 && $.trim($("#djdAreaOpt").val()) != "0" && typeof (areaCookie) != "undefined" && areaCookie) {
            areaCookie.updateUserLastSelectedArea();
        }
    },

    AdminAddProductCart: function (obj, ckbut, uid, cmno, isquote) {//cmno 参数 ：定制留言编号，添加人：罗建林，添加时间：2014.04.09
        var kcount = 0;
        var count = "";
        var pkey = "";
        var gkey = "";
        var useUnit = "";
        var isContainZeroPrice = false;
        $(obj).parent().prev().find('.hyProitem').each(function () {
            var currentCount = parseFloat($(this).find('input').val());
            var currentUnit= $(this).find("option:selected").attr("unit");
            if (currentCount <= 0) {
                return;
            }
            currentUnit = currentUnit ? currentUnit : "0";
            var unitRateControl = $(this).find("[id^='ddlUnit_']");
            var unitRate = 1;
            if (unitRateControl.length != 0) {
                unitRate = parseFloat(unitRateControl.val());
            }
            currentCount = currentCount * unitRate;
            kcount += Math.floor(currentCount);
            if (Math.floor(currentCount) > 0) {
                if ($(this).find('input').attr("maxstore") != "-1") {
                }
                count += currentCount + ",";
                useUnit += currentUnit + ",";
                var pgArray = new Array();
                pgArray = $(this).find('input').attr("id").split("-");
                pkey += pgArray[1] + ",";
                gkey += pgArray[0] + ",";
            }

            var userPriceObj = $(this).find("span[id^='spanUserPrice_']");
            var userPrice = userPriceObj.length == 0 ? 0 : parseFloat(userPriceObj.attr("basicValue"));
            if (userPrice == 0) {
                isContainZeroPrice = true;
            }
        });

        if (kcount <= 0) {
            Ecshop.Tool.Hint.Error({ info: '请录入订购数量！' });
            return;
        }

        if (isContainZeroPrice) {
            Ecshop.Tool.Hint.Error({ info: '价格为0的商品不能加入购物车！' });
            return;
        }
        
        $.ajax({
            type: Ecs.ProductInfo.DefaultMethod,
            url: Ecs.ProductInfo.AddCartUrl,
            data: {
                type: "addcart",
                p: pkey.substr(0, pkey.length-1),
                g: gkey.substr(0, gkey.length - 1),
                c: count.substr(0, count.length - 1),
                useUnit:useUnit,
                gp: "",
                a: $("#hdUserID").val(),
                u: (isquote == "true" ? "1" : "0")
            },
            dataType: 'JSON',
            success: function (data) {
                var targetCart = isquote == "true" ? "报价篮" : "购物车";
                if (data.iCookie == 1) {
                    $(".shopping_numbermark").html(data.ct);
                    if (ckbut == 1) {
                        window.location.href = "/ordernew/adminb2borderlist.aspx?a=" + $("#hdUserID").val() + (cmno == undefined || cmno == "" ? "" : "&cmno=" + cmno);
                        return;
                    }
                    Ecshop.Tool.Hint.Ok({ info: ("加入" + targetCart + "成功") });
                } else {
                    Ecshop.Tool.Hint.Warn({ info: ("加入" + targetCart + "失败:" + data.ct) });
                }
            }
        });
    },
    /*收藏商品*/
    FavoriteProduct: function (obj) {
        var pid = $(obj).attr("lang");
        $.ajax({
            type: Ecs.ProductInfo.DefaultMethod,
            url: "/controls/proudct.ashx",
            data: "type=fav&favpid=" + pid,
            dataType: 'JSON',
            success: function (data) {
                if (data.msg == "1") {
                    try {
                        $(obj).attr("src", function () {
                            return "/images/yes_fav.gif";
                        });
                        Ecs.Tool.addLayer(obj, "收藏成功！");
                    } catch (Error) {
                    }
                } else if (data.msg == "0") {
                    Ecs.Tool.addLayerWoring(obj, "收藏失败！");
                } else if (data.msg == "-1") {
                    $.dialog.open('/LoginDialog.aspx?resulturi=' + encodeURI(document.location.href), { width: '400px', height: '540px', title: false });
                } else if (data.msg == "-2") {
                    Ecs.Tool.addLayerWoring(obj, "你已收藏过此商品！");
                }
            }
        });
        //        ProudctAjax("/controls/proudct.ashx", "type=fav&favpid=" + $(this).attr("lang"), 0, this);
    },
    //
    Inquirys: function () {
        window.location.href = "/user/Product_Inquiry.aspx?p=" + Ecs.ProductInfo.option.GoodJson[0].productid;
    },

    //到货通知事件
    Notify: function (e) {
        var ecs = this;
        var productid = $("#notice").attr("lang");
        var goodsid = "0";
        var purl = window.location.pathname;
        if (ecs.option.SelectItem == null) {
            Ecs.Tool.addLayerWoring(e, "请选择相应的规格。");
            return false;
        } else {
            goodsid = ecs.option.SelectItem.goodsid;
        }
        var provinceId = $("#djdStockOpt").val();
        var cityId = $("#djdCityOpt").val();
        var countyId = $("#djdAreaOpt").val();
        var locationId = provinceId + "-" + cityId + "-" + countyId;
        window.location.href = "/order/product_gnotify.aspx?pid=" + productid + "&goodsid=" + goodsid + "&purl=" + purl + "&areaId=" + locationId;
    },

    //阴止事件冒泡
    StopEvent: function (e) {
        e = e || window.event;
        if (e.stopPropagation)
            e.stopPropagation();
        else e.cancelBubble = true;
        if (e.preventDefault)
            e.preventDefault();
        else e.returnValue = false;
    },

    //绑定事件
    BindEvent: function () {
        var ecs = this;
        $(document).bind({
            "click": function () {
                //隐藏地区选择
                $("#selectArea").removeClass("curr");
                $(".product_attr .selectArea").hide();
                $("#showwholesale").hide();
            }
        });
        $("#djdAreaOpt").bind("click", function () {
            $("#selectArea").removeClass("curr");
        });
        //图片列表滚动处理
        if ($(".rollBox").length > 0)
            Ecs.ProductInfo.SmallProductPicScroll(".rollBox");
        $(".productchoose .buynuminput").bind({
            "click": function () {
                $(this).focus().select();
            }
        });

        //增加购买量按钮绑定事件
        if ($(".productchoose .btn-add").length > 0)
            $(".productchoose .btn-add").bind({
                "click": function () {
                    ecs.UpdateBuyCount(1, this);
                }
            });
        //减少购买量按钮绑定事件
        if ($(".productchoose .btn-reduce").length > 0)
            $(".productchoose .btn-reduce").bind({
                "click": function () {
                    ecs.UpdateBuyCount(-1, this);
                }
            });
        $(".productchoose .buynuminput").bind({
            blur: function () {
                var val = $(this).val();
                if (!isNaN(val))
                    ecs.UpdateBuyCount(val, this, true);
                else
                    $(this).val(1);
            },
            change: function () {
                var val = $(this).val();
                if (!isNaN(val))
                    ecs.UpdateBuyCount(val, this, true);
                else
                    $(this).val(1);
            }
        });


        //显示地区选择
        if ($("#selectArea").length > 0) {
            $("#selectArea").bind({
                "click": function (event) {
                    $("#selectArea").toggleClass("curr");
                    ecs.ShowSelectArea();
                    ecs.StopEvent(event);
                }
            });
            //绑定关闭按钮事件
            $(".product_attr .selectArea .close").bind({
                "click": function (event) {
                    $("#selectArea").toggleClass("curr");
                    ecs.ShowSelectArea();
                    ecs.StopEvent(event);
                }
            });
        }
        //地区Select选择单击事件
        if ($("select.select").length != 0) {
            $("select.select").bind({
                "click": function (event) {
                    ecs.StopEvent(event);
                    return false;
                }
            });
        }
        //规格选择事件
        if ($(".select_colorszie ul li span[class!='sptitle']").length != 0) {
            $(".select_colorszie ul li span[class!='sptitle']").bind({
                "click": function () {
                    ecs.SelectSpec($(this));
                }
            });
        }
        //购买,加入购物车,报价
        if ($(".addshoppingcart input").length != 0) {
            $(".addshoppingcart input").each(function () {
                var btn = this;
                if ($(btn).attr("id") != "notice" && $(btn).attr("id") != "inquiry" && $(btn).attr("id") != "outURL")
                    $(this).bind({
                        "click": function () {
                            ecs.AddProductCart(btn);
                        }
                    });

                //询价
                if ($(btn).attr("id") == "inquiry") {
                    $(this).bind({
                        "click": function () {
                            ecs.Inquirys();
                        }
                    });
                }
                //到货通知
                if ($(btn).attr("id") == "notice") {
                    $(this).bind({
                        "click": function () {
                            ecs.Notify(btn);
                        }
                    });
                }
            });
        }

        //去除链接点击出现的虚线
        $('a').bind('focus', function () {
            if (this.blur) { //如果支持 this.blur
                this.blur();
            }
        });
        //评论切换
        //        alert(Ecs.ProductInfo.option.XsComment);
        if (Ecs.ProductInfo.option.XsComment) {
            $(".Comment").find("input").click(function () {
                pageIndex = 0;
                InitDataComm(pageIndex);
            });
        }
    },
    /*绑定组合优惠事件*/
    BindCombinationSalesEvent: function () {
        var ecs = this;
        /*优惠套装数量 start*/
        //增加购买量按钮绑定事件
        if ($(".grouprod .btn-add").length > 0)
            $(".grouprod .btn-add").bind({
                "click": function () {
                    var combineqty = $("input.combineqty").val();
                    $("input.combineqty").val(Math.floor(combineqty) + 1);
                }
            });
        //减少购买量按钮绑定事件
        if ($(".grouprod .btn-reduce").length > 0)
            $(".grouprod .btn-reduce").bind({
                "click": function () {
                    var combineqty = $("input.combineqty").val();
                    if (Math.floor(combineqty) > 1)
                        $("input.combineqty").val(Math.floor(combineqty) - 1);
                }
            });

        $(".grouprod .combineqty").bind({
            blur: function () {
                var val = $(this).val();
                if (isNaN(val))
                    $(this).val(1);
            }
        });
        $("#btnCollocationPackage").bind("click", function () {
            ecs.AddCollocationPackage($(this));
        });

        $("#btnAddCollocationPackage").bind("click", function () {
            ecs.AddCollocationPackageToCartShop($(this));
        });

        $("#grouprod_mc_2 div.btn input[type='button']").bind("click", function () {
            ecs.AddAccessory($(this));
        });

        $("#grouprod_mc_2 ul.clearfix :checkbox").bind("click", function () {
            ecs.CalculateAccessoryPrice($(this));
        });
        /*优惠套装数量 end*/
    },

    JqueryZoom: function (istuan) {
        istuan = istuan == undefined ? false : istuan;
        if (!istuan) {
            var product_zoom = function () {
                $(".jqzoom").jqueryzoom({
                    xzoom: 400,
                    yzoom: 400,
                    offset: 10, //zooming div default offset(default offset value is 10)
                    position: "right", //zooming div position(default position value is "right")
                    preload: 1,
                    lens: 1
                });
            }
            // product_zoom();
            var customerhost = window.location.host;
            var img = new Image();
            var imgurl = $(".zoomimg").attr("jqimg");
            if (imgurl.indexOf("http://") >= 0)
                imgurl = imgurl;
            else
                imgurl = "http://" + customerhost + imgurl;
            img.src = imgurl;
            if ($.browser.msie) {
                if ($.browser.msie && ($.browser.version == "7.0" || $.browser.version == "8.0")) {
                    img.onreadystatechange = function () {
                        ie7imagetime = window.setInterval(function () {
                            if (img.readyState == "complete" || img.readyState == "loaded") {
                                //alert(imgurl + "-" + img.width);
                                window.clearInterval(ie7imagetime);
                                if (img.width > 357 || img.height > 357) { //290
                                    product_zoom();
                                }
                            }
                        }, 200);
                    };
                } else {
                    img.onreadystatechange = function () {
                        if (img.readyState == "complete" || img.readyState == "loaded") {
                            //alert(img.width);
                            if (img.width > 357 || img.height > 357) {
                                product_zoom();
                            }
                        }
                    };
                }
            }
                //以上是判断IE
            else {
                img.onload = function () {
                    if (img.complete == true) {
                        if (img.width > 357 || img.height > 357) {
                            product_zoom();
                        }
                    }
                };
            }

            $(".preload").each(function (i) {
                if (i != 0) {
                    document.body.removeChild(this);
                }
            });
            //$(".zoomimg").attr("jqimg", $(".zoomimg").attr("jqimg").replace("_310x310.jpg", "").replace("_300x300.jpg", ""));

            $($("#List1 .pic").get(0)).addClass("clickboder");
            $($("#List1 .pic s").get(0)).show();
        }
        $(".ScrCont .pic").click(function () {
            var t = $(this);
            var t_picimg = t.find("img");
            var index = t.index("#List1 .pic");
            $(".pic").removeClass("clickboder");
            $(".pic").find("s").hide();
            t.find("s").show();
            t.addClass("clickboder");
            if (t_picimg.attr("src").indexOf("taobao") > -1) {
                $(".zoomimg").attr("src", t_picimg.attr("src").replace("80x80.jpg", "310x310.jpg"));
            } else {
                $(".zoomimg").attr("src", t_picimg.attr("src").replace("80x80.jpg", "510x510.jpg"));
            }
            $(".jqzoom").attr("href", t_picimg.attr("src").replace("_80x80.jpg", ""));
            $(".zoomimg").attr("jqimg", t_picimg.attr("src").replace("_80x80.jpg", ""));
            Ecs.ProductInfo.RollnextCount = index + 1;
        });
    },

    /*初始化入口*/
    initMain: function (option) {
        $(".product_body_bottom").attr("style", "display:block !important");
        this.option.GoodJson = null;
        $.extend(this.option, option);
        var ecs = this;
        //促销框
        ecs.option.PromoTip = $('#i_promoinfo').tooltip({
            focus: true,
            type: 'hover',
            //title: '促销明细',
            position: 'bottom',
            content: '',
            padding: 0,
            maxWidth: 600
        });
        ecs.BindEvent();
        //显示按钮
        ecs.ShowButton();
        //详细咨询切换
        Ecs.Tool.ProductInfoTab();
        //放大镜相关
        ecs.JqueryZoom();
        //初始化地区
        ecs.initArea();
        //初始化规格集合
        ecs.initSpectCombining(ecs.convertGoodsToSpec());
        //设置默认货品
        ecs.initDefaultGood(ecs);
        //初始化分享
        ecs.initShare(ecs);
        var productid = ecs.option.GoodJson[0].productid;
        var precount = $.jCookie("productcount_" + productid);
        if (precount != null && precount != undefined && precount != "undefined" && !isNaN(Number(precount)) && Number(precount) > 0) {
            $(".productchoose .buynuminput").val(precount);
            $.jCookie("productcount_" + productid, "undefined", { path: "/" });
        }
    },

    /*初始化默认货品*/
    initDefaultGood: function (ecs) {
        if (ecs.option.GoodJson != null && ecs.option.GoodJson.length == 1) {
            ecs.option.SelectItem = ecs.option.GoodJson[0];
            var item = ecs.option.SelectItem;
            if (item.pdtdesc.length > 0) {
                var props = item.pdtdesc.split(';');
                $.each(props, function (i, propitem) {
                    if (propitem.length != 0)
                        $(".select_colorszie ul li span[vid='" + propitem.split(":")[1] + "']").click(); //.addClass("select");
                });
            } else {
                Ecs.ProductInfo.AsynLoadGoodsInfo();
            }
        } else {
            var isselect = false;
            $.each(ecs.option.GoodJson, function (i, item) {
                if (item.isselect == "true") {
                    isselect = true;
                    ecs.option.SelectItem = item;
                    var props = item.pdtdesc.split(';');
                    $.each(props, function (i, propitem) {
                        if (propitem.length != 0)
                            $(".select_colorszie ul li span[vid='" + propitem.split(":")[1] + "']").click(); //.addClass("select");
                    });
                    return;
                }
            });
            if (!isselect) {
                ecs.ShowPriceRange();
                ecs.ShowPromoteInfo(null);
            }
        }
    },
    /*初始化分享*/
    initShare: function (ecs) {
        if (ecs.option.IsShowShareBtn) {
            var shareUrlObj = $("#hdShareUrl");
            var shareUrl = shareUrlObj.length == 0 ? "" : shareUrlObj.val();
            var divQRCode = $("#divQRCode");
            var qrImgUrl = divQRCode.length == 0 ? "" : divQRCode.find(".divShare").attr("SharePictureUrl");
            var shareHtml = '<div class="divShare" iconsize="1" summary=" "' +
                (qrImgUrl == "" ? '' : 'SharePictureUrl="' + qrImgUrl + '"') +
                (shareUrl == "" ? '' : 'ShareUrl="' + shareUrl + '"') + '>' +
                '<span style="float:left;">分享到:</span>' +
             '</div>';
            $(".partake").html(shareHtml);//opt.ShareBtnHtml);
            if ($("#divQRCode").length != 0) {
                $(".partake").find("div:first").append('<a href="javascript:void(0)" id="site-qrcode" style="background-position: -264px -24px;" class="share" onmouseover="ShowQRCode();" onmouseout="HideQRCode();">二维码</a>');
            }

            if (JiaThis != undefined && typeof (JiaThis.SetJiaThisHtml) == "function") {
                JiaThis.SetJiaThisHtml();
            }
        }
    },

    /*初始化地区*/
    initArea: function () {
        if (typeof (areaObj) == "undefined" || !areaObj) {
            areaObj = {
                ProvinceId: "0",
                CityId: "0",
                AreaId: "0"
            }
        }
        threeSelect({
            s1: 'djdStockOpt',
            s2: 'djdCityOpt',
            s3: 'djdAreaOpt',
            v1: areaObj.ProvinceId,
            v2: areaObj.CityId,
            v3: areaObj.AreaId,
            fn: function () {
                $(".product_attr .selectArea").hide();
                if ($("#djdStockOpt option:selected").text() == "" || $("#djdStockOpt option:selected").text() == undefined || $("#djdStockOpt option:selected").text() == null) {
                    $("#selectAreachild").html('请选择地区');
                } else {
                    $("#selectAreachild").html($("#djdStockOpt option:selected").text() + $("#djdCityOpt option:selected").text() + $("#djdAreaOpt option:selected").text());
                }
                areaObj.ProvinceId = $("#djdStockOpt").val();
                areaObj.CityId = $("#djdCityOpt").val();
                areaObj.AreaId = $("#djdAreaOpt").val();
                if (typeof (areaCookie) != "undefined" && areaCookie) {
                    areaCookie.setAreaCookie();
                    SetUserLastSelectedArea();
                }
                Ecs.ProductInfo.AsynLoadGoodsInfo();
                //服务商品列表
                Ecs.ProductInfo.AsynLoadServerProvider();
            }
        });
    },

    /*    --------------初始化规格集合begin-------------        */
    initSpectCombining: function (data) {
        var i, j, skuKeys = Ecs.ProductInfo.getObjKeys(data);
        for (i = 0; i < skuKeys.length; i++) {
            var skuKey = skuKeys[i]; //一条SKU信息key
            var sku = data[skuKey]; //一条SKU信息value
            var skuKeyAttrs = skuKey.split(";"); //SKU信息key属性值数组
            var len = skuKeyAttrs.length;

            //对每个SKU信息key属性值进行拆分组合
            for (j = 0; j < len; j++) {

                //单个属性值作为key直接放入Ecs.ProductInfo.SKUResult
                Ecs.ProductInfo.add2SKUResult(skuKeyAttrs[j], sku);
                //对本组SKU信息key属性进行组合，组合个数为j
                (j > 0 && j < len - 1) && Ecs.ProductInfo.combineSKU(skuKeyAttrs, j, sku);
            }

            //结果集接放入Ecs.ProductInfo.SKUResult
            Ecs.ProductInfo.SKUResult[skuKey] = {};
            Ecs.ProductInfo.SKUResult[skuKey].item = [sku.item];
        }
    },

    /*将货品转换成对应的规格组合*/
    convertGoodsToSpec: function () {
        var ecs = this;
        $.each(ecs.option.GoodJson, function (i, item) {
            var pdtdescArry = item.pdtdesc.split(";");
            var key = "";
            for (var j = 0; j < pdtdescArry.length; j++) {
                if ($.trim(pdtdescArry[j]).length == 0)
                    continue;
                if (key.length == 0)
                    key += pdtdescArry[j].split(":")[1];
                else
                    key += ";" + pdtdescArry[j].split(":")[1];
            }
            var keys = key.split(";");
            //keys.sort(function (value1, value2) {
            //    return parseInt(value1) - parseInt(value2);
            //});
            key = keys.join(";");
            ecs.SKUData[key] = {};
            ecs.SKUData[key].item = [item];
        });

        return ecs.SKUData;
    },

    //把组合的key放入结果集Ecs.ProductInfo.SKUResult
    add2SKUResult: function (key, sku) {
        if (key == "546")
            key = "546";
        if (Ecs.ProductInfo.SKUResult[key]) { //SKU信息key属性·
            Ecs.ProductInfo.SKUResult[key].item.push(sku.item[0]);
        } else {
            Ecs.ProductInfo.SKUResult[key] = {};
            Ecs.ProductInfo.SKUResult[key].item = [sku.item];
        }
    },
    //对一条SKU信息进行拆分组合
    combineSKU: function (skuKeyAttrs, cnum, sku) {
        var len = skuKeyAttrs.length;
        for (var i = 0; i < len; i++) {
            var key = skuKeyAttrs[i];
            for (var j = i + 1; j < len; j++) {
                if (j + cnum <= len) {
                    var tempArr = skuKeyAttrs.slice(j, j + cnum); //安装组合个数获得属性值·
                    var genKey = key + ";" + tempArr.join(";"); //得到一个组合key
                    Ecs.ProductInfo.add2SKUResult(genKey, sku);
                }
            }
        }
    },
    /*    --------------end-------------       */

    /*团抢购页面使用*/
    limiInit: function (limiOption) {

        var ecs = this;
        var opt = this.option;
        var maxcount = limiOption.maxcount;
        var mincount = limiOption.mincount;
        //商品图片切换
        ecs.JqueryZoom(true);

        Ecs.Tool.ProductInfoTab(true);
        //评论切换
        //        alert(Ecs.ProductInfo.option.XsComment);
        if (Ecs.ProductInfo.option.XsComment) {
            $(".Comment").find("input").click(function () {
                pageIndex = 1;

                InitDataComm(pageIndex);

            });
        }
        $(".product_tab ul li").first().click();
        $(document).on('click', '#buy', function () {
            Ecs.ProductInfo.DirectBuy($(this));
        });
        //团抢购购买数量修改
        var gp = Ecs.ProductInfo.CheckProductType();
        if (gp == "buy" || gp == "gp") {
            var ecs = Ecs.ProductInfo;
            if ($("#input-num-plus").length > 0)
                $("#input-num-plus").bind({
                    "click": function () {
                        ecs.UpdateBuyCount(1, this);
                    }
                });
            //减少购买量按钮绑定事件
            if ($("#input-num-minus").length > 0)
                $("#input-num-minus").bind({
                    "click": function () {
                        ecs.UpdateBuyCount(-1, this);
                    }
                });
            var inputnumtext = $("#input-num-text");
            if (inputnumtext.length > 0) {
                if ($.trim(inputnumtext.val()).length == 0 || Number($.trim(inputnumtext.val())) == 0)
                    inputnumtext.val(Math.floor(mincount) > 0 ? mincount : "1");
                if (inputnumtext.attr("mincount") == undefined || inputnumtext.attr("mincount") == null || Number(inputnumtext.attr("mincount")) == 0)
                    inputnumtext.attr("mincount", Math.floor(mincount) > 0 ? mincount : "1");
                if (inputnumtext.attr("maxcount") == undefined || inputnumtext.attr("maxcount") == null)
                    inputnumtext.attr("maxcount", maxcount);
                inputnumtext.bind({
                    blur: function () {
                        var val = $(this).val();
                        if (!isNaN(val))
                            ecs.UpdateBuyCount(val, this, true);
                        else
                            $(this).val(1);
                    },
                    change: function () {
                        var val = $(this).val();
                        if (!isNaN(val))
                            ecs.UpdateBuyCount(val, this, true);
                        else
                            $(this).val(1);
                    }
                });
            }
        }

        var imgControl = $("#team_images").find("img");
        var imgUrl = imgControl.length > 0 ? imgControl.attr("src") : "";
        if (imgUrl != "")
            imgUrl = "http://" + window.location.host + imgUrl;
        var shareHtml = '' +
            '<div class="divShare" iconsize="1" summary=" "' + (imgUrl == "" ? '' : 'SharePictureUrl="' + imgUrl + '"') + '>' +
                '<span style="float:left;">分享到:</span>' +
            '</div>';
        $(".partake").html(shareHtml);

        if (JiaThis != undefined && typeof (JiaThis.SetJiaThisHtml) == "function") {
            JiaThis.SetJiaThisHtml();
        }
    },

    GroupBuyInit: function ()//组合购买代码
    {
        if ($("#grouprod_mc_1").length > 0 || $("#grouprod_mc_2").length > 0) {
            if ($(".grouprod").width() < 900) {
                gpslider($("#grouprod_mc_1"), 3, $("#grouprod_mc_1 .prv"), $("#grouprod_mc_1 .next"));
                gpslider($("#grouprod_mc_2"), 3, $("#grouprod_mc_2 .prv"), $("#grouprod_mc_2 .next"));
                $("#grouprod_mc_1 .smt a:first").trigger("click");
            } else {
                gpslider($("#grouprod_mc_1"), 4, $("#grouprod_mc_1 .prv"), $("#grouprod_mc_1 .next"));
                gpslider($("#grouprod_mc_2"), 4, $("#grouprod_mc_2 .prv"), $("#grouprod_mc_2 .next"));
                $("#grouprod_mc_1 .smt a:first").trigger("click");
            }
        }
    },

    OpenOfferInfo: function (id) {
        var obj = $("#" + id);
        if (obj.css("display") == "" || obj.css("display") == "none") {
            obj.css("display", "block");
        }
        else {
            obj.css("display", "none");
        }
        var prop = $("#brand-bar-pop");
        if (prop.attr("class").indexOf("brand-bar-pop-curr") < 0) {
            prop.addClass("brand-bar-pop-curr");
        }
        else {
            prop.removeClass("brand-bar-pop-curr");
        }
    },
    AddStoreFavorite: function (storeId) {
        $.ajax({
            url: '/user/controls/StoreFavoriteHandler.ashx',
            type: 'POST',
            data: {
                type: "AddStoreFavorite",
                StoreId: storeId
            },
            dataType: 'json',
            success: function (data) {
                if (data.Errors.IsValidSuccess) {
                    Ecshop.Tool.Hint.Ok({
                        info: "收藏店铺成功！", second: 1
                    });
                } else {
                    if (data.Errors.ErrorItems[0].PropertyName == "UnLogin") {
                        $.dialog.open('/LoginDialog.aspx?resulturi=' + encodeURI(document.location.href), { width: '400px', height: '540px', title: false, lock: true });
                    } else {
                        Ecshop.Tool.Hint.Error({ info: data.Errors.ErrorItems[0].ErrorMessage });
                    }
                }
            }
        });
    },
    //团购抢购
    DirectBuy: function (e) {
        var pid = e.attr("pid");
        var gid = e.attr("gid");
        window.location.href = '/productinfo/' + $.trim(pid) + "-" + $.trim(gid) + ".html";
        return;
    }

};

Ecs.Tool = {
    IsTransaction: false,
    IsAsk: false,
    IsComment: false,
    //    详细咨询切换
    ProductInfoTab: function (isTuan) {
        var tool = this;
        $(".productinfopanel .panel").hide();
        $(".productinfopanel .panel").eq(0).show();


        if ($("#lmydiv").html() == "Yes") {
            $(".productinfopanel .panel").last().prev().show();
            $(".productinfopanel .panel").last().show();
            InitDataComm(0);
            InitAskData(0);
            $(".panel").find(".btns").show();
        }
        var productTab = $("#product_tab");
        var productInfoPanel = $(".productinfopanel");
        var productTabTop = 0;
        if (productTab.length > 0) {
            productTabTop = productTab.offset().top;
        }
        window.onscroll = function () {
            if ($(window).scrollTop() > productTabTop) {
                productTab.addClass("prodtab_fix");
            }
            else if ($(window).scrollTop() == productTabTop || $(window).scrollTop() < productTabTop) {
                productTab.removeClass("prodtab_fix");
            }
        }
        $(".product_tab ul li").click(function () {
            var index = $(".product_tab ul li").index($(this));
            $(".product_tab ul li").removeClass("selected");
            $(this).addClass("selected");
            $(".productinfopanel .panel").hide();
            $(".productinfopanel .panel").each(function (i) {
                if (i == index) {
                    $(this).focus().show();
                    if (productTab.css("position") == "fixed") {
                        productTab.removeClass("prodtab_fix");
                        $(window).scrollTop(productTab.offset().top - productTab.outerHeight(true));
                    }
                    if (i == 0) {
                        $(".productinfopanel .panel").eq(0).show();

                        if ($("#lmydiv").html() == "Yes") {
                            $(".productinfopanel .panel").last().prev().show();
                            $(".productinfopanel .panel").last().show();
                            InitDataComm(0);
                            InitAskData(0);
                            $(".panel").find(".btns").hide();
                        }

                    }
                }
            })
            var type = $(this).attr("type");

            type = undefined ? "" : type;
            if (type == "transaction") {
                if (!tool.IsTransaction) {
                    tool.IsTransaction = true;
                    InitTransactionData(0);
                }
            }
            //            alert(Ecs.ProductInfo.option.XsAsk);
            if (type == "ask" && Ecs.ProductInfo.option.XsAsk) {
                if (!tool.IsAsk) {
                    tool.IsAsk = true;
                    InitAskData(0);

                }
                $(".panel").find(".btns").show();
            }
            //            alert(Ecs.ProductInfo.option.XsComment);
            if (type == "comment" && Ecs.ProductInfo.option.XsComment) {
                if (!tool.IsComment) {
                    tool.IsComment = true;
                    InitDataComm(0);
                }
            }
        });
        $(".Comment .li").click(function () {
            var idx = $(".Comment .li").index($(this));
            $(".Commentpanel").find(".cdiv").hide();
            $(".Commentpanel").find(".cdiv").each(function (i) {
                if (i == idx) {
                    $(this).show();
                    var idxcalss = $(this).attr("id");
                    idxcalss = "." + idxcalss;
                    $(".Commentpanel").find(".page div").css("display", "none");
                    $(idxcalss).show();
                }
            })
        });
    },
    //正确
    addLayer: function (tid, msg, fn) {
        var mspn = document.createElement("span");
        mspn.style.margin = "4px 2px 4px 34px";
        mspn.style.display = "block";
        mspn.style.fontSize = "12px"
        mspn.style.color = "#3D882D";
        mspn.style.overflow = "hidden";
        mspn.innerHTML = msg;
        var Layer = document.createElement("div");
        Layer.style.background = "url(/images/24h_a006.png) no-repeat 5px center #E8F8E7";
        Layer.style.border = "1px solid #3D882D";
        Layer.style.position = "absolute";
        Layer.style.zIndex = "9999";
        Layer.style.overflow = "hidden";
        Layer.style.height = "auto";
        Layer.id = "LayerMsg";
        Layer.appendChild(mspn);
        var left = 0;
        var top = 0;
        if ($(tid).html() == null) {
            left = window.screen.availWidth / 2;
            top = ($(document).scrollTop() + window.screen.height / 2) - 150;
        } else {
            left = $(tid).offset().left;
            top = $(tid).offset().top - 35;
        }
        Layer.style.left = left + "px";
        Layer.style.top = top + "px";
        document.body.appendChild(Layer);

        var creatediv = window.setInterval(function () {
            try {
                document.body.removeChild(document.getElementById("LayerMsg"));
                if (typeof (fn) == "function") {
                    fn();
                }
            }
            catch (Erorr) { }
            window.clearInterval(creatediv);
        }, 2000);
        return false;
    },
    //错误
    addLayerWoring: function (tid, msg, fn) {
        var mspn = document.createElement("span");
        mspn.style.margin = "4px 2px 4px 34px";
        mspn.style.display = "block";
        mspn.style.fontSize = "12px"
        mspn.style.color = "#C00";
        mspn.style.overflow = "hidden";
        mspn.innerHTML = msg;
        var Layer = document.createElement("div");
        Layer.style.background = "url(/images/24h_a002.png) no-repeat  5px center #FBE2E2";
        Layer.style.border = "1px solid #C66161 ";
        Layer.style.position = "absolute";
        Layer.style.zIndex = "9999";
        Layer.style.overflow = "hidden";
        Layer.style.height = "auto";
        Layer.id = "LayerMsg";
        Layer.appendChild(mspn);
        var left = 0;
        var top = 0;
        if ($(tid).html() == null) {
            left = window.screen.availWidth / 2;
            top = ($(document).scrollTop() + window.screen.height / 2) - 150;
        } else {
            left = $(tid).offset().left;
            top = $(tid).offset().top - 35;
        }
        Layer.style.left = left + "px";
        Layer.style.top = top + "px";
        document.body.appendChild(Layer);

        var creatediv = window.setInterval(function () {
            try {
                document.body.removeChild(document.getElementById("LayerMsg"));
                if (typeof (fn) == "function") {
                    fn();
                }
            }
            catch (Erorr) { }
            window.clearInterval(creatediv);
        }, 2000);
        return false;
    },
    AddBookmark: function () {
        var title = $(".product_t").find("font").html(); //商品标题
        var content = title; //推广内容
        var productUrl = window.location.href; //网站访问地址
        if (document.all) {
            window.external.AddFavorite(productUrl, title);
        } else if (window.sidebar) {
            window.sidebar.addPanel(title, productUrl, "")

        } else if (window.opera && window.print) {
            var addbm = document.getElementById('addBookmark');
            addbm.setAttribute('rel', 'sidebar');
            addbm.setAttribute('href', productUrl);
            addbm.setAttribute('title', title);
            addbm.click();
        } else {
            alert("加入收藏失败，请按CTRL+D来手工添加!");
        }
    },
    ShareTo: function (webName) {
        var url = "";
        var title = $(".product_t").find("font").html(); //商品标题
        var content = title; //推广内容
        var productUrl = window.location.href; //网站访问地址
        var img = $(".zoomimg").attr("src");  //商品图片地址
        switch (webName) {
            case "tsina":
                url = "http://v.t.sina.com.cn/share/share.php?url=" + productUrl + "&title=" + content;
                break;
            case "kaixin001":
                url = "http://www.kaixin001.com/repaste/share.php?" + "rtitle=" + content + "&rcontent=" + title + productUrl + "&rurl=" + productUrl;
                break;
            case "gmail":
                url = "https://mail.google.com/mail/?view=cm&fs=1&tf=1&ui=2&shva=1&to&su=" + title + "&body=" + productUrl;
                break;
            case "renren":
                url = "http://share.renren.com/share/buttonshare.do?link=" + productUrl + "&title=" + title;
                break;
            case "qq":
                url = "http://shuqian.qq.com/post?from=3&title=" + encodeURIComponent(title) + "&uri=" + productUrl + "&jumpback=2&noui=1"
                break;
            case "qqblog":
                url = "http://v.t.qq.com/share/share.php?site=" + productUrl + "&title=" + encodeURIComponent(title) + "&pic=" + img + "&url=" + productUrl
                break;
            case "qzone":
                var url = "http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=" + encodeURIComponent(productUrl)
                break;
            case "baidu":
                url = "http://cang.baidu.com/do/add?it=" + encodeURIComponent(title) + "&iu=" + encodeURIComponent(productUrl) + "&fr=ien#nw=1";
                break;
            case "douban":
                //url="http://www.douban.com/recommend/?title="+title+"&comment="+content+"&url="+productUrl;
                url = 'http://www.douban.com/recommend/?url=' + productUrl + '&title=' + encodeURIComponent(title);
                break;
            case "google":
                //url="http://www.google.com/reader/link?url='"+productUrl+"'&title='"+title+"'&srcURL="+img+"'";
                url = "http://www.google.com/bookmarks/mark?op=edit&hl=zh-CN&output=popup&bkmk=" + productUrl + "&title=" + title;
                break;
            case "taojianghu":
                url = "http://share.jianghu.taobao.com/share/addShare.htm?url=" + productUrl + "&title=" + title;
                break;
            case "vivi":
                url = "http://vivi.sina.com.cn/collect/icollect.php?title=" + escape(title) + "&url=" + escape(productUrl) + "&desc=" + escape(content);
                break;
            case "51":
                url = "http://share.51.com/share/share.php?type=8&title=" + encodeURIComponent(title) + "&vaddr=" + encodeURIComponent(productUrl);
                break;
            case "yahoo":
                url = "http://myweb.cn.yahoo.com/popadd.html?url=" + encodeURIComponent(productUrl) + "&title=" + encodeURIComponent(title);
                break;
            case "bai":
                url = "http://bai.sohu.com/appLogin.jsp?bru=/app/share/blank/add.do?link=" + productUrl + "&title=" + title;
                break;
            case "msn":
                url = "http://profile.live.com/badge/?url=" + encodeURIComponent(productUrl) + "&title=" + encodeURIComponent(title) + "&description=" + encodeURIComponent(content) + "&screenshot=" + img;
                break;
            default:
                break;
        }
        window.open(url, "_blank");
    },
    HTMLEnCode: function (str) {
        var s = "";
        if (!str||str.length == 0) return "";
        s = str.replace(/&/g, "&gt;");
        s = s.replace(/</g, "&lt;");
        s = s.replace(/>/g, "&gt;");
        s = s.replace(/    /g, "&nbsp;");
        s = s.replace(/\'/g, "'");
        s = s.replace(/\"/g, "&quot;");
        s = s.replace(/\n/g, "<br>");
        return s;
    },
    HTMLDeCode: function (str) {
        var s = "";
        if (!str||str.length == 0) return "";
        s = str.replace(/&amp;/g, "&");
        s = s.replace(/&lt;/g, "<");
        s = s.replace(/&gt;/g, ">");
        s = s.replace(/&nbsp;/g, "    ");
        s = s.replace(/'/g, "\'");
        s = s.replace(/&quot;/g, "\"");
        s = s.replace(/<br>/g, "\n");
        s = s.replace(/&#39;/g, "\'");
        return s;
    },
    Base64: {
        option: {
            _keyStr: ""
        },

        // private property
        // public method for encoding
        encode: function (input) {
            var output = "";
            var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
            var i = 0;
            input = Ecs.Tool.Base64._utf8_encode(input);
            while (i < input.length) {
                chr1 = input.charCodeAt(i++);
                chr2 = input.charCodeAt(i++);
                chr3 = input.charCodeAt(i++);
                enc1 = chr1 >> 2;
                enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
                enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
                enc4 = chr3 & 63;
                if (isNaN(chr2)) {
                    enc3 = enc4 = 64;
                } else if (isNaN(chr3)) {
                    enc4 = 64;
                }
                output = output +
			Ecs.Tool.Base64.option._keyStr.charAt(enc1) + Ecs.Tool.Base64.option._keyStr.charAt(enc2) +
			Ecs.Tool.Base64.option._keyStr.charAt(enc3) + Ecs.Tool.Base64.option._keyStr.charAt(enc4);
            }
            return output;
        },
        // public method for decoding
        decode: function (input) {
            var output = "";
            var chr1, chr2, chr3;
            var enc1, enc2, enc3, enc4;
            var i = 0;
            input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");
            while (i < input.length) {
                enc1 = Ecs.Tool.Base64.option._keyStr.indexOf(input.charAt(i++));
                enc2 = Ecs.Tool.Base64.option._keyStr.indexOf(input.charAt(i++));
                enc3 = Ecs.Tool.Base64.option._keyStr.indexOf(input.charAt(i++));
                enc4 = Ecs.Tool.Base64.option._keyStr.indexOf(input.charAt(i++));
                chr1 = (enc1 << 2) | (enc2 >> 4);
                chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
                chr3 = ((enc3 & 3) << 6) | enc4;
                output = output + String.fromCharCode(chr1);
                if (enc3 != 64) {
                    output = output + String.fromCharCode(chr2);
                }
                if (enc4 != 64) {
                    output = output + String.fromCharCode(chr3);
                }
            }
            output = Ecs.Tool.Base64._utf8_decode(output);
            return output;
        },
        // private method for UTF-8 encoding
        _utf8_encode: function (string) {
            string = string.replace(/\r\n/g, "\n");
            var utftext = "";
            for (var n = 0; n < string.length; n++) {
                var c = string.charCodeAt(n);
                if (c < 128) {
                    utftext += String.fromCharCode(c);
                } else if ((c > 127) && (c < 2048)) {
                    utftext += String.fromCharCode((c >> 6) | 192);
                    utftext += String.fromCharCode((c & 63) | 128);
                } else {
                    utftext += String.fromCharCode((c >> 12) | 224);
                    utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                    utftext += String.fromCharCode((c & 63) | 128);
                }

            }
            return utftext;
        },
        // private method for UTF-8 decoding
        _utf8_decode: function (utftext) {
            var string = "";
            var i = 0;
            var c = c1 = c2 = 0;
            while (i < utftext.length) {
                c = utftext.charCodeAt(i);
                if (c < 128) {
                    string += String.fromCharCode(c);
                    i++;
                } else if ((c > 191) && (c < 224)) {
                    c2 = utftext.charCodeAt(i + 1);
                    string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
                    i += 2;
                } else {
                    c2 = utftext.charCodeAt(i + 1);
                    c3 = utftext.charCodeAt(i + 2);
                    string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                    i += 3;
                }
            }
            return string;
        }
    }
}

Ecs.ProductList = {
    AddCartCookiList: function (e) {
        var price = $(e).parent().parent().find(".product_price .oldprice strong").html();
        if (price != "&yen;0.00" || $(e).attr("isv").toString() != "True") {
            var pid = $(e).attr("vid");
            var txtclass = ".txt" + pid;
            var count = 1;
            var obfind = $(txtclass);
            if (typeof (obfind.val()) == "undefined" || obfind.val() == "" || obfind.val() == null) {
                count = 1;
            } else {
                count = obfind.val();
            }
            var c = $(txtclass).attr("c");
            if (typeof (c) == "undefined") {
                c = -1;
            }
            if (count > 0) {
                if (Math.floor(c) >= Math.floor(count) || c == -1 || c == -2) {
                    $.ajax({
                        type: Ecs.ProductInfo.DefaultMethod,
                        url: Ecs.ProductInfo.AddCartUrl,
                        data: "type=addcart&p=" + pid + "&g=&c=" + count + "&gp=0",
                        dataType: 'JSON',
                        success: function (data) {
                            if (data.iCookie == 0) {
                                $(".shopping_numbermark").html(data.ct);
                                Ecs.Tool.addLayerWoring(e, "加入购物车失败");
                            } else if (data.iCookie == 1) {
                                $(".shopping_numbermark").html(data.ct);
                                Ecs.Tool.addLayer(e, "加入购物车成功");
                            } else if (data.iCookie == 2 || data.iCookie == 3) {
                                window.location.href = "/login.aspx";
                            } else if (data.iCookie == 4) {
                                Ecs.Tool.addLayerWoring(e, "库存不足，不能加入购物车！");
                            } else {
                                Ecs.Tool.addLayerWoring(e, "加入购物车失败");
                            }
                        }
                    });
                } else {
                    Ecs.Tool.addLayerWoring(e, "库存不足，不能加入购物车。");
                    if ($(txtclass).attr("c") > 0) {
                        obfind.val($(txtclass).attr("c"));
                    } else {
                        obfind.val("1");
                    }
                }
            } else {
                obfind.val("1");
                Ecs.Tool.addLayerWoring(e, "购买数量必须大于0。");
            }
        } else {
            Ecs.Tool.addLayerWoring(e, "此商品只能询价不能购买。");
        }
    },
    OpenProductListBanner: function (e) {
        if (e.text() == "展开") {
            e.prev().find(".productlistbannerhide").removeClass("productlistbannerhide").addClass("productlistbannershow");
            e.text("收起").addClass("on");
        }
        else if (e.text() == "收起") {
            e.prev().find(".productlistbannershow").removeClass("productlistbannershow").addClass("productlistbannerhide");
            e.text("展开").removeClass("on");
        }
    }
};

var gpslider = function (sliderobj, visible, prvbtn, nextbtn) {
    var liobj = sliderobj.find("li");
    var ulobj = sliderobj.find("ul");
    var width = "";
    var li_length = liobj.length;
    var step = 1;
    var count = 0;
    var newtp = 0;
    var oldtp = 0;
    width = li_length * liobj.outerWidth(true);
    ulobj.css({ "width": width + "px", "position": "relative" });
    var _init = function () {
        if (li_length <= visible) {
            prvbtn.hide();
            nextbtn.hide();
            return;
        } else {
            prvbtn.show();
            nextbtn.show();
            step = Math.ceil(li_length / visible);
        }
    };
    var _slider = function (type) {
        if (li_length > visible) {
            if (type == "prv") {
                if (count <= 0) {
                    count = step - 1;
                } else {
                    count--;
                }
                ulobj.stop(true, false).animate({
                    "left": visible * liobj.outerWidth(true) * count * -1 + "px"
                }, 1000);
            }
            if (type == "next") {
                if (count >= step - 1) {
                    count = 0;
                } else {
                    count++;
                }
                ulobj.stop(true, false).animate({
                    "left": visible * liobj.outerWidth(true) * count * -1 + "px"
                }, 1000);
            }
        }
    };
    _init();
    $(prvbtn).bind("click", function () {
        _slider("prv");
    });
    $(nextbtn).bind("click", function () {
        _slider("next");
    });
    sliderobj.find(".smt a").bind("click", function () {
        sliderobj.find(".smt a").removeClass("curr");
        sliderobj.find(".baseprod .gpp").hide();
        sliderobj.find(".baseprod ." + $(this).attr("rel")).show();
        $(this).addClass("curr");
        if ($(this).attr("rel") == "0") {
            liobj.show();
            li_length = liobj.length;
            _init();
            ulobj.css("left", "0px");
        } else {
            liobj.hide();
            sliderobj.find(".smc li." + $(this).attr("rel")).show();
            li_length = sliderobj.find(".smc li." + $(this).attr("rel")).length;
            if (sliderobj.attr("id") == "grouprod_mc_1") {
                newtp = 0;
                oldtp = 0;
                sliderobj.find(".smc li." + $(this).attr("rel")).each(function () {
                    var _combineqty = $(this).find("span.combineqty").html();
                    newtp = newtp + parseFloat($(this).attr("xj")) * parseFloat(_combineqty);
                    oldtp = oldtp + parseFloat($(this).attr("yj")) * parseFloat(_combineqty);
                });
                var combineqty = sliderobj.find(".baseprod ." + $(this).attr("rel") + " span.combineqty").html();
                newtp += parseFloat(sliderobj.find(".baseprod ." + $(this).attr("rel") + " h4").attr("xj")) * parseFloat(combineqty);
                oldtp += parseFloat(sliderobj.find(".baseprod ." + $(this).attr("rel") + " h4").attr("yj")) * parseFloat(combineqty);
                sliderobj.find(("#newtp")).text(newtp.toFixed(2));
                sliderobj.find(("#oldtp")).text(oldtp.toFixed(2));
            }
            //
            _init();
            ulobj.css("left", "0px");
        }
    });
};

var WholesaleType =
{
    /// <summary>
    /// 打折
    /// </summary>
    DaZhe: "0",

    /// <summary>
    /// 总减价
    /// </summary>
    JianJia: "2",

    /// <summary>
    /// 满送商品
    /// </summary>
    ZengPin: "4",

    /// <summary>
    /// 免运费
    /// </summary>
    MianYunFei: "9",

    /// <summary>
    /// 团购
    /// </summary>
    GroupBuy: "100",

    /// <summary>
    /// 限时抢购
    /// </summary>
    ScareBuy: "200"
}
/*地区选择*/
function threeSelect(config) {
    if (addressData == undefined) return;
    var threeSelectData = addressData;
    var $s1 = $("#" + config.s1);
    var $s2 = $("#" + config.s2);
    var $s3 = $("#" + config.s3);
    var v1 = config.v1 ? config.v1 : null;
    var v2 = config.v2 ? config.v2 : null;
    var v3 = config.v3 ? config.v3 : null;
    var fn = config.fn;

    $.each(threeSelectData, function (k, v) {
        if (k == 1 && v1 == 0) {//设置默认选中值
            appendOptionTo($s1, v.Name, v.Code, v.Code);
        } else {
            appendOptionTo($s1, v.Name, v.Code, v1);
        }
    });
    $s1.change(function () {
        $s2.html("");
        $s3.html("");
        appendOptionTo($s2, "城市", "", v2);
        if (this.selectedIndex == 0) {
            appendOptionTo($s3, "区县", "", v3);
            return;
        }
        var s1_curr_val = this.options[this.selectedIndex == -1 ? 0 : this.selectedIndex].value;
        $.each(threeSelectData, function (k, v) {
            if (s1_curr_val == v.Code) {
                if (v.items) {
                    $.each(v.items, function (k, v) {
                        if (k == 0 && v2 == 0) {//设置默认选中值
                            appendOptionTo($s2, v.Name, v.Code, v.Code);
                        } else {
                            appendOptionTo($s2, v.Name, v.Code, v2);
                        }
                    });
                }
            }
        });
        if ($s2[0].options.length == 0) { appendOptionTo($s2, "...", "", v2); }
        $s2.change();
    }).change();
    $s2.change(function () {
        $s3.html("");
        appendOptionTo($s3, "区县", "", v3);
        if (this.selectedIndex < 1) return;
        var s1_curr_val = $s1[0].options[$s1[0].selectedIndex].value;
        var s2_curr_val = this.options[this.selectedIndex].value;
        $.each(threeSelectData, function (k, v) {
            if (s1_curr_val == v.Code) {
                if (v.items) {
                    $.each(v.items, function (k, v) {

                        if (s2_curr_val == v.Code) {
                            $.each(v.items, function (k, v) {
                                if (k == 0 && v3 == 0) {//设置默认选中值
                                    appendOptionTo($s3, v.Name, v.Code, v.Code);
                                } else
                                    appendOptionTo($s3, v.Name, v.Code, v3);
                            });

                        }
                    });
                }
            }
        });

        if ($s3[0].options.length == 0) { appendOptionTo($s3, "...", "", v3); }
    }).change();
    $s3.change(function () {
        if (typeof (fn) == "function") {
            fn();
        }
    });
    if (typeof (fn) == "function") {
        fn();
    }

    function appendOptionTo($o, k, v, d) {
        var $opt = $("<option>").text(k).val(v);
        if (v == d) {
            $opt.attr("selected", "selected");
        }
        $opt.appendTo($o);
    }
}

function SetUserLastSelectedArea() {

    $.ajax({
        url: '/controls/AreaHandler.ashx',
        async: false,
        type: 'POST',
        data: {
            type: "UpdateUserLastSelectedArea",
            areaId: areaObj.AreaId
        },
        dataType: 'html',
        success: function (data) { }
    });
}